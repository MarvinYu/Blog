<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head profile="http://gmpg.org/xfn/11">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Martin Kleppmann&rsquo;s blog</title>
    <link rel="stylesheet" type="text/css" media="screen, print, handheld" href="/css/typography.css" />
<link rel="stylesheet" type="text/css" media="screen" href="/css/style.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/pygments-default.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/ansi2html.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/customizations.css?3" />
<!--[if lt IE 8]>
    <link rel="stylesheet" href="/css/ie.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/martinkl?format=xml" title="Martin Kleppmann's blog" />

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" type="text/javascript"></script>
<script src="http://downloads.mailchimp.com/js/jquery.form-n-validate.js" type="text/javascript"></script>
<script src="/form.js" type="text/javascript"></script>

</head>

<body class="wordpress">
    <div id="page">
        <p id="top">
    <a id="to-content" href="#content" title="Skip to content">Skip to content</a>
</p>

<div id="header">
    <div class="wrapper">
        <strong id="blog-title">
            <a href="/" title="Home" rel="home">Martin Kleppmann</a>
        </strong>
        <p id="blog-description">Entrepreneurship, web technology and the user experience</p>
    </div>
</div>

<div id="sub-header">
    <div class="wrapper">
        <div id="navigation">
            <ul>
                <li class="page_item"><a href="/contact.html" title="About/Contact">About/Contact</a></li>
            </ul>
        </div>
    </div>
</div>

<hr class="divider">

<div class="wrapper">

        <div id="content">
            
    <div class="hentry full p1 post publish">
        <h1 class="entry-title full-title">
            <a href="/2013/08/12/system-operations-over-seven-centuries.html" rel="bookmark">System operations over seven centuries</a>
        </h1>

        <div class="entry-content full-content">
            <p>On a <a href='http://www.planetoutdoor.de/de/touren/detail.htm?tour=20874&amp;region=138'>walk</a> in the Alps last week we came across a wonderful piece of engineering, more successful than most software systems could claim to be. It is the system of <em><a href='http://de.wikipedia.org/wiki/Waal_%28Bew%C3%A4sserung%29'>Waale</a></em>, an ancient irrigation system in the <a href='http://en.wikipedia.org/wiki/Vinschgau'>Vinschgau</a>, South Tyrol.</p>

<p>The climate in the Vinschgau is sunny, dry and windy. Without irrigation, agriculture would barely be possible, but if water from mountain streams is channelled to the fields, <a href='http://www.vip.coop/'>apple trees</a> and meadows can flourish. The area has been inhabited at least since the Bronze Age, and it is likely that artificial irrigation started early. The oldest documents on the Waal system date from the 12th century, and some Waale built in the 14th century are still in use today.</p>
<p>
  <a href='http://www.flickr.com/photos/martinkleppmann/9485964300/in/set-72157635017969591' style='display: block; float: left'><img height='375' src='/2013/08/leitenwaal-1.jpg' width='250' /></a>
  <a href='http://www.flickr.com/photos/martinkleppmann/9482339202/in/set-72157635017969591' style='display: block; float: right'><img height='375' src='/2013/08/leitenwaal-2.jpg' width='250' /></a>
</p><p style='clear: both' />
<p>The pictures in this post show the Leitenwaal and the <a href='http://www.youtube.com/watch?v=hO0BAjPh5n4'>Berkwaal</a> near the village of <a href='http://en.wikipedia.org/wiki/Schluderns'>Schluderns</a> in South Tyrol, northern Italy. These two conduits carry water from a mountain stream (the Saldurbach) to the fields and meadows around Schluderns. Along their combined length of about six kilometers, they overcome many obstacles: twisting along the face of steep mountainsides, crossing aqueducts over deep ravines, tunnelling underneath boulders, before they finally arrive at the fields they supply.</p>

<p>Some sections look almost like a natural stream &#8211; except that they flow across the mountainside, not down, because they are designed to cover the greatest possible distance with the smallest possible loss in altitude. Other sections are more obviously artificial, where the furrow has been lined with flat stones or blanks of wood.</p>

<p>This system was originally built almost 700 years ago, using the technology available at the time: spade, axe, hammer and chisel. Of course, nowadays, electric pumps can take water from the river at the valley floor, and sprinkle it on the fields on the slopes above. But for many centuries, the only feasible option was to take water from a stream at high altitude, and let it flow down from there.</p>
<p><a href='http://www.flickr.com/photos/martinkleppmann/9483183131/in/set-72157635017969591'><img height='366' src='/2013/08/source.jpg' width='550' /></a></p>
<p>Here a feed of water is taken from a stream, and carried along a wooden gulley: the input to the irrigation system. Along the way, gates regulate the flow of water in the direction of various farms. For centuries, the details of water distribution &#8211; how much water shall be directed towards which farm at which time &#8211; have been governed by detailed agreements, and led to many disputes between farmers.</p>
<p><a href='http://www.flickr.com/photos/martinkleppmann/9482379264/in/set-72157635017969591'><img height='366' src='/2013/08/distribution.jpg' width='550' /></a></p>
<p>If the system were to fail for too long, crops would wither, so it was important that the system was always well-maintained and operational. And of course, parts of the system would fail from time to time &#8211; erosion, landslides, decay, accidents or any number of other faults could occur. When a part of the system broke, it was replaced using whatever technology was available at the time.</p>

<p>Thus, the system is now a patchwork of different water-carrying technologies from different ages. The oldest &#8220;pipes&#8221; were made from hollowed-out tree trunks, and some of them are still in use (water flows through tree trunks across a ravine in the left picture below). Later replacements have been made with concrete, steel or plastic pipes &#8211; whatever is believed to be the most reliable solution in the long term.</p>
<p>
  <a href='http://www.flickr.com/photos/martinkleppmann/9485976696/in/set-72157635017969591' style='display: block; float: left'><img height='375' src='/2013/08/pipes-1.jpg' width='250' /></a>
  <a href='http://www.flickr.com/photos/martinkleppmann/9485971172/in/set-72157635017969591' style='display: block; float: right'><img height='375' src='/2013/08/pipes-2.jpg' width='250' /></a>
</p><p style='clear: both' />
<p>Perhaps the most impressive aspect of this system are its <em>operability</em> features, i.e. the things that help the operator of the Waal in his job of keeping the system running smoothly. For example, at regular intervals, the water flows through gratings which filter out twigs or other objects before they can cause blockages in pipes. The gratings are cleaned regularly, and tools for clearing out pipes are kept near the Waal. Routine inspections help detect problems early, before they escalate and cause further damage.</p>

<p>After heavy rainfall or melting of snow, the influx of water may exceed the Waal&#8217;s capacity. This is problematic: if the Waal bursts its banks, those banks would be damaged by erosion or washed away, making the problem much worse. Thus, the system includes overflow points at which water is channelled back into the natural stream if the Waal is over capacity (left photo below).</p>

<p>There is even an ingenious monitoring system (right photo below). A waterwheel is placed in the stream, and a cowbell is attached so that it rings on each rotation of the wheel (<a href='http://www.youtube.com/watch?v=LbCG8AUJKSk'>video</a>). Thus, the operator can tell the rate of water flow from a distance, simply by listening for the rhythm of the bell.</p>
<p>
  <a href='http://www.flickr.com/photos/martinkleppmann/9483176701/in/set-72157635017969591' style='display: block; float: left'><img height='375' src='/2013/08/operations-1.jpg' width='250' /></a>
  <a href='http://www.flickr.com/photos/martinkleppmann/9485968436/in/set-72157635017969591' style='display: block; float: right'><img height='375' src='/2013/08/operations-2.jpg' width='250' /></a>
</p><p style='clear: both' />
<p>The <em>Waaler</em>, the operator in charge of maintenance of the <em>Waal</em>, is an important and highly-regarded member of the local community. Traditionally, this role is elected every year on the first Sunday of Lent. The operator can be re-elected by the community if they were satisfied with his work in the previous year.</p>

<p>Looking at the lessons from this ancient irrigation system, and adapting them to software systems, my take-aways are:</p>

<ul>
<li>Good interface design can survive through multiple generations of technology. A stream of water, flowing downhill, is a simple interface that can be implemented in stone-lined furrows, hollowed-out tree trunks, concrete, steel and plastic pipes, and more.</li>

<li>When replacing obsolete technology with new technology, some work is required to join them up &#8211; two pieces of standardised plastic piping may fit snugly, but you can&#8217;t expect the same from a hollow tree trunk interfacing with a plastic pipe.</li>

<li>New technology is not necessarily better than old technology. Hollow tree trunks are still used to feed water into 21st-century sprinkler irrigation systems.</li>

<li>API rate limits are not a new thing. They are, in fact, centuries old.</li>

<li>Continuously monitor the health of your system, and detect problems early.</li>

<li>Operations doesn&#8217;t just happen; it has to be someone&#8217;s job.</li>

<li>If a system solves an important problem, is well-engineered and well-operated, it can stick around for a very, very long time.</li>
</ul>
        </div>

        <div class="by-line">
            <address class="author vcard full-author">
                <span class="by">By</span> <a class="url fn" href="http://martin.kleppmann.com/">Martin Kleppmann</a>
            </address>
            <span class="date full-date">
                <abbr class="published" title="2013-08-12T00:00:00+01:00">12 Aug 2013</abbr>
            </span>
        </div>

        <p class="comments-link">
            <a href="/2013/08/12/system-operations-over-seven-centuries.html#disqus_thread">Comments</a>
        </p>

        <div class="clear"></div>
    </div>

    <div class="hentry full p1 post publish">
        <h1 class="entry-title full-title">
            <a href="/2013/05/24/improving-security-of-ssh-private-keys.html" rel="bookmark">Improving the security of your SSH private key files</a>
        </h1>

        <div class="entry-content full-content">
            <p>Ever wondered how those key files in <code>~/.ssh</code> actually <em>work</em>? How secure are they actually?</p>

<p>As you probably do too, I use ssh many times every single day &#8212; every <code>git fetch</code> and <code>git push</code>, every deploy, every login to a server. And recently I realised that to me, ssh was just some crypto voodoo that I had become accustomed to using, but I didn&#8217;t really understand. That&#8217;s a shame &#8212; I like to know how stuff works. So I went on a little journey of discovery, and here are some of the things I found.</p>

<p>When you start reading about &#8220;crypto stuff&#8221;, you very quickly get buried in an avalanche of acronyms. I will briefly mention the acronyms as we go along; they don&#8217;t help you understand the concepts, but they are useful in case you want to Google for further details.</p>

<p>Quick recap: If you&#8217;ve ever used public key authentication, you probably have a file <code>~/.ssh/id_rsa</code> or <code>~/.ssh/id_dsa</code> in your home directory. This is your RSA/DSA private key, and <code>~/.ssh/id_rsa.pub</code> or <code>~/.ssh/id_dsa.pub</code> is its public key counterpart. Any machine you want to log in to needs to have your public key in <code>~/.ssh/authorized_keys</code> on that machine. When you try to log in, your SSH client uses a digital signature to prove that you have the private key; the server checks that the signature is valid, and that the public key is authorized for your username; if all is well, you are granted access.</p>

<p>So what is actually inside this private key file?</p>

<h2 id='the_unencrypted_private_key_format'>The unencrypted private key format</h2>

<p>Everyone recommends that you protect your private key with a passphrase (otherwise anybody who steals the file from you can log into everything you have access to). If you leave the passphrase blank, the key is not encrypted. Let&#8217;s look at this unencrypted format first, and consider passphrase protection later.</p>

<p>A ssh private key file typically looks something like this:</p>

<pre><code>-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEArCQG213utzqE5YVjTVF5exGRCkE9OuM7LCp/FOuPdoHrFUXk
y2MQcwf29J3A4i8zxpES9RdSEU6iIEsow98wIi0x1/Lnfx6jG5Y0/iQsG1NRlNCC
aydGvGaC+PwwWiwYRc7PtBgV4KOAVXMZdMB5nFRaekQ1ksdH/360KCGgljPtzTNl
09e97QBwHFIZ3ea5Eih/HireTrRSnvF+ywmwuxX4ubDr0ZeSceuF2S5WLXH2+TV0
   ... etc ... lots of base64 blah blah ...
-----END RSA PRIVATE KEY-----</code></pre>

<p>The private key is an <a href='http://en.wikipedia.org/wiki/ASN.1'>ASN.1</a> data structure, serialized to a byte string using <a href='http://en.wikipedia.org/wiki/X.690#DER_encoding'>DER</a>, and then <a href='http://tools.ietf.org/html/rfc4648'>Base64</a>-encoded. ASN.1 is roughly comparable to JSON (it supports various data types such as integers, booleans, strings and lists/sequences that can be nested in a tree structure). It&#8217;s very widely used for cryptographic purposes, but it has somehow fallen out of fashion with the web generation (I don&#8217;t know why, it seems like a pretty decent format).</p>

<p>To look inside, let&#8217;s generate a fake RSA key without passphrase using <a href='http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-keygen&amp;sektion=1'>ssh-keygen</a>, and then decode it using <a href='http://www.openssl.org/docs/apps/asn1parse.html'>asn1parse</a>:</p>

<pre><code>$ ssh-keygen -t rsa -N &#39;&#39; -f test_rsa_key
$ openssl asn1parse -in test_rsa_key
    0:d=0  hl=4 l=1189 cons: SEQUENCE
    4:d=1  hl=2 l=   1 prim: INTEGER           :00
    7:d=1  hl=4 l= 257 prim: INTEGER           :C36EB2429D429C7768AD9D879F98C...
  268:d=1  hl=2 l=   3 prim: INTEGER           :010001
  273:d=1  hl=4 l= 257 prim: INTEGER           :A27759F60AEA1F4D1D56878901E27...
  534:d=1  hl=3 l= 129 prim: INTEGER           :F9D23EF31A387694F03AD0D050265...
  666:d=1  hl=3 l= 129 prim: INTEGER           :C84415C26A468934F1037F99B6D14...
  798:d=1  hl=3 l= 129 prim: INTEGER           :D0ACED4635B5CA5FB896F88BB9177...
  930:d=1  hl=3 l= 128 prim: INTEGER           :511810DF9AFD590E11126397310A6...
 1061:d=1  hl=3 l= 129 prim: INTEGER           :E3A296AE14E7CAF32F7E493FDF474...</code></pre>

<p>Alternatively, you can paste the Base64 string into Lapo Luchini&#8217;s excellent <a href='http://lapo.it/asn1js/'>JavaScript ASN.1 decoder</a>. You can see that ASN.1 structure is quite simple: a sequence of nine integers. Their meaning is defined in <a href='http://tools.ietf.org/html/rfc2313#section-7.2'>RFC2313</a>. The first integer is a version number (0), and the third number is quite small (65537) &#8211; the public exponent <em>e</em>. The two important numbers are the 2048-bit integers that appear second and fourth in the sequence: the RSA modulus <em>n</em>, and the private exponent <em>d</em>. These numbers are used directly in the <a href='http://en.wikipedia.org/wiki/RSA_%28algorithm%29'>RSA algorithm</a>. The remaining five numbers can be derived from <em>n</em> and <em>d</em>, and are only cached in the key file to speed up certain operations.</p>

<p>DSA keys are similar, a <a href='http://blog.ngas.ch/archives/2008/10/23/asn_1_for_dsa_public_and_private_keys/index.html'>sequence of six integers</a>:</p>

<pre><code>$ ssh-keygen -t dsa -N &#39;&#39; -f test_dsa_key
$ openssl asn1parse -in test_dsa_key
    0:d=0  hl=4 l= 444 cons: SEQUENCE
    4:d=1  hl=2 l=   1 prim: INTEGER           :00
    7:d=1  hl=3 l= 129 prim: INTEGER           :E497DFBFB5610906D18BCFB4C3CCD...
  139:d=1  hl=2 l=  21 prim: INTEGER           :CF2478A96A941FB440C38A86F22CF...
  162:d=1  hl=3 l= 129 prim: INTEGER           :83218C0CA49BA8F11BE40EE1A7C72...
  294:d=1  hl=3 l= 128 prim: INTEGER           :16953EA4012988E914B466B9C37CB...
  425:d=1  hl=2 l=  21 prim: INTEGER           :89A356E922688EDEB1D388258C825...</code></pre>

<h2 id='passphraseprotected_keys'>Passphrase-protected keys</h2>

<p>Next, in order to make life harder for an attacker who manages to steal your private key file, you protect it with a passphrase. How does this actually work?</p>

<pre><code>$ ssh-keygen -t rsa -N &#39;super secret passphrase&#39; -f test_rsa_key
$ cat test_rsa_key
-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,D54228DB5838E32589695E83A22595C7

3+Mz0A4wqbMuyzrvBIHx1HNc2ZUZU2cPPRagDc3M+rv+XnGJ6PpThbOeMawz4Cbu
lQX/Ahbx+UadJZOFrTx8aEWyZoI0ltBh9O5+ODov+vc25Hia3jtayE51McVWwSXg
wYeg2L6U7iZBk78yg+sIKFVijxiWnpA7W2dj2B9QV0X3ILQPxbU/cRAVTd7AVrKT
    ... etc ...
-----END RSA PRIVATE KEY-----</code></pre>

<p>We&#8217;ve gained two header lines, and if you try to parse that Base64 text, you&#8217;ll find it&#8217;s no longer valid ASN.1. That&#8217;s because the entire ASN.1 structure we saw above has been encrypted, and the Base64-encoded text is the output of the encryption. The header tells us the encryption algorithm that was used: <a href='http://en.wikipedia.org/wiki/Advanced_Encryption_Standard'>AES-128</a> in <a href='http://en.wikipedia.org/wiki/Block_cipher_modes_of_operation#Cipher-block_chaining_.28CBC.29'>CBC mode</a>. The 128-bit hex string in the <code>DEK-Info</code> header is the <a href='http://en.wikipedia.org/wiki/Initialization_vector'>initialization vector</a> (IV) for the cipher. This is pretty standard stuff; all common crypto libraries can handle it.</p>

<p>But how do you get from the passphrase to the AES encryption key? I couldn&#8217;t find it documented anywhere, so I had to dig through the OpenSSL source to find it:</p>

<ol>
<li>Append the first 8 bytes of the IV to the passphrase, without a separator (serves as a salt).</li>

<li>Take the MD5 hash of the resulting string (once).</li>
</ol>

<p>That&#8217;s it. To prove it, let&#8217;s decrypt the private key manually (using the IV/salt from the <code>DEK-Info</code> header above):</p>

<pre><code>$ tail -n +4 test_rsa_key | grep -v &#39;END &#39; | base64 -D |    # get just the binary blob
  openssl aes-128-cbc -d -iv D54228DB5838E32589695E83A22595C7 -K $(
    ruby -rdigest/md5 -e &#39;puts Digest::MD5.hexdigest([&quot;super secret passphrase&quot;,0xD5,0x42,0x28,0xDB,0x58,0x38,0xE3,0x25].pack(&quot;a*cccccccc&quot;))&#39;
  ) |
  openssl asn1parse -inform DER</code></pre>

<p>&#8230;which prints out the sequence of integers from the RSA key in the clear. Of course, if you want to inspect the key, it&#8217;s much easier to do this:</p>

<pre><code>$ openssl rsa -text -in test_rsa_key -passin &#39;pass:super secret passphrase&#39;</code></pre>

<p>but I wanted to demonstrate exactly how the AES key is derived from the password. This is important because the private key protection has two weaknesses:</p>

<ul>
<li>The digest algorithm is hard-coded to be MD5, which means that without changing the format, it&#8217;s not possible to upgrade to another hash function (e.g. SHA-1). This could be a problem if MD5 turns out not to be good enough.</li>

<li>The hash function is only applied once &#8212; there is no <a href='http://en.wikipedia.org/wiki/Key_stretching'>stretching</a>. This is a problem because MD5 and AES are both fast to compute, and thus a short passphrase is quite easy to break with brute force.</li>
</ul>

<p>If your private SSH key ever gets into the wrong hands, e.g. because someone steals your laptop or your backup hard drive, the attacker can try a huge number of possible passphrases, even with moderate computing resources. If your passphrase is a dictionary word, it can probably be broken in a matter of seconds.</p>

<p>That was the bad news: the passphrase on your SSH key isn&#8217;t as useful as you thought it was. But there is good news: you can upgrade to a more secure private key format, and everything continues to work!</p>

<h2 id='better_key_protection_with_pkcs8'>Better key protection with PKCS#8</h2>

<p>What we want is to derive a symmetric encryption key from the passphrase, and we want this derivation to be slow to compute, so that an attacker needs to buy more computing time if they want to brute-force the passphrase. If you&#8217;ve seen the <a href='http://codahale.com/how-to-safely-store-a-password/'>use bcrypt</a> meme, this should sound very familiar.</p>

<p>For SSH private keys, there are a few standards with clumsy names (acronym alert!) that can help us out:</p>

<ul>
<li><a href='http://tools.ietf.org/html/rfc2898#section-5.2'>PKCS #5 (RFC 2898)</a> defines <a href='http://en.wikipedia.org/wiki/PBKDF2'>PBKDF2</a> (Password-Based Key Derivation Function 2), an algorithm for deriving an encryption key from a password by applying a hash function repeatedly. PBES2 (Password-Based Encryption Scheme 2) is also defined here; it simply means using a PBKDF2-generated key with a symmetric cipher.</li>

<li><a href='http://tools.ietf.org/html/rfc5208'>PKCS #8 (RFC 5208)</a> defines a format for storing encrypted private keys that supports PBKDF2. OpenSSL transparently supports private keys in PKCS#8 format, and OpenSSH uses OpenSSL, so if you&#8217;re using OpenSSH that means you can swap your traditional SSH key files for PKCS#8 files and everything continues to work as normal!</li>
</ul>

<p>I don&#8217;t know why <code>ssh-keygen</code> still generates keys in SSH&#8217;s traditional format, even though a better format has been available for years. Compatibility with servers is not a concern, because the private key never leaves your machine. Fortunately it&#8217;s easy enough to <a href='http://www.openssl.org/docs/apps/pkcs8.html'>convert to PKCS#8</a>:</p>

<pre><code>$ mv test_rsa_key test_rsa_key.old
$ openssl pkcs8 -topk8 -v2 des3 \
    -in test_rsa_key.old -passin &#39;pass:super secret passphrase&#39; \
    -out test_rsa_key -passout &#39;pass:super secret passphrase&#39;</code></pre>

<p>If you try using this new PKCS#8 file with a SSH client, you should find that it works exactly the same as the file generated by <code>ssh-keygen</code>. But what&#8217;s inside it?</p>

<pre><code>$ cat test_rsa_key
-----BEGIN ENCRYPTED PRIVATE KEY-----
MIIFDjBABgkqhkiG9w0BBQ0wMzAbBgkqhkiG9w0BBQwwDgQIOu/S2/v547MCAggA
MBQGCCqGSIb3DQMHBAh4q+o4ELaHnwSCBMjA+ho9K816gN1h9MAof4stq0akPoO0
CNvXdtqLudIxBq0dNxX0AxvEW6exWxz45bUdLOjQ5miO6Bko0lFoNUrOeOo/Gq4H
dMyI7Ot1vL9UvZRqLNj51cj/7B/bmfa4msfJXeuFs8jMtDz9J19k6uuCLUGlJscP
    ... etc ...
-----END ENCRYPTED PRIVATE KEY-----</code></pre>

<p>Notice that the header/footer lines have changed (<code>BEGIN ENCRYPTED PRIVATE KEY</code> instead of <code>BEGIN RSA PRIVATE KEY</code>), and the plaintext <code>Proc-Type</code> and <code>DEK-Info</code> headers have gone. In fact, the whole key file is once again a ASN.1 structure:</p>

<pre><code>$ openssl asn1parse -in test_rsa_key
    0:d=0  hl=4 l=1294 cons: SEQUENCE
    4:d=1  hl=2 l=  64 cons: SEQUENCE
    6:d=2  hl=2 l=   9 prim: OBJECT            :PBES2
   17:d=2  hl=2 l=  51 cons: SEQUENCE
   19:d=3  hl=2 l=  27 cons: SEQUENCE
   21:d=4  hl=2 l=   9 prim: OBJECT            :PBKDF2
   32:d=4  hl=2 l=  14 cons: SEQUENCE
   34:d=5  hl=2 l=   8 prim: OCTET STRING      [HEX DUMP]:3AEFD2DBFBF9E3B3
   44:d=5  hl=2 l=   2 prim: INTEGER           :0800
   48:d=3  hl=2 l=  20 cons: SEQUENCE
   50:d=4  hl=2 l=   8 prim: OBJECT            :des-ede3-cbc
   60:d=4  hl=2 l=   8 prim: OCTET STRING      [HEX DUMP]:78ABEA3810B6879F
   70:d=1  hl=4 l=1224 prim: OCTET STRING      [HEX DUMP]:C0FA1A3D2BCD7A80DD61F4C0287F8B2D...</code></pre>

<p>Use Lapo Luchini&#8217;s <a href='http://lapo.it/asn1js/'>JavaScript ASN.1 decoder</a> to display a nice ASN.1 tree structure:</p>

<pre><code>Sequence (2 elements)
|- Sequence (2 elements)
|  |- Object identifier: 1.2.840.113549.1.5.13            // using PBES2 from PKCS#5
|  `- Sequence (2 elements)
|     |- Sequence (2 elements)
|     |  |- Object identifier: 1.2.840.113549.1.5.12      // using PBKDF2 -- yay! :)
|     |  `- Sequence (2 elements)
|     |     |- Byte string (8 bytes): 3AEFD2DBFBF9E3B3    // salt
|     |     `- Integer: 2048                              // iteration count
|     `- Sequence (2 elements)
|          Object identifier: 1.2.840.113549.3.7          // encrypted with Triple DES, CBC
|          Byte string (8 bytes): 78ABEA3810B6879F        // initialization vector
`- Byte string (1224 bytes): C0FA1A3D2BCD7A80DD61F4C0287F8B2DAB46A43E...  // encrypted key blob</code></pre>

<p>The format uses <a href='http://en.wikipedia.org/wiki/Object_identifier'>OIDs</a>, numeric codes allocated by a registration authority to unambiguously refer to algorithms. The OIDs in this key file tell us that the encryption scheme is <a href='http://oid-info.com/get/1.2.840.113549.1.5.13'>pkcs5PBES2</a>, that the key derivation function is <a href='http://oid-info.com/get/1.2.840.113549.1.5.12'>PBKDF2</a>, and that the encryption is performed using <a href='http://oid-info.com/get/1.2.840.113549.3.7'>des-ede3-cbc</a>. The hash function can be explicitly specified if needed; here it&#8217;s omitted, which means that it <a href='http://tools.ietf.org/html/rfc3370#section-4.4.1'>defaults</a> to <a href='http://tools.ietf.org/html/rfc2104'>hMAC-SHA1</a>.</p>

<p>The nice thing about having all those identifiers in the file is that if better algorithms are invented in future, we can upgrade the key file without having to change the container file format.</p>

<p>You can also see that the key derivation function uses an iteration count of 2,048. Compared to just one iteration in the traditional SSH key format, that&#8217;s good &#8212; it means that it&#8217;s much slower to brute-force the passphrase. The number 2,048 is currently hard-coded in OpenSSL; I hope that it will be configurable in future, as you could probably increase it without any noticeable slowdown on a modern computer.</p>

<h2 id='conclusion_better_protection_for_your_ssh_private_keys'>Conclusion: better protection for your SSH private keys</h2>

<p>If you already have a strong passphrase on your SSH private key, then converting it from the traditional private key format to PKCS#8 is roughly comparable to adding two extra keystrokes to your passphrase, for free. And if you have a weak passphrase, you can take your private key protection from &#8220;easily breakable&#8221; to &#8220;slightly harder to break&#8221;.</p>

<p>It&#8217;s so easy, you can do it right now:</p>

<pre><code>$ mv ~/.ssh/id_rsa ~/.ssh/id_rsa.old
$ openssl pkcs8 -topk8 -v2 des3 -in ~/.ssh/id_rsa.old -out ~/.ssh/id_rsa
$ chmod 600 ~/.ssh/id_rsa
# Check that the converted key works; if yes, delete the old one:
$ rm ~/.ssh/id_rsa.old</code></pre>

<p>The <code>openssl pkcs8</code> command asks for a passphrase three times: once to unlock your existing private key, and twice for the passphrase for the new key. It doesn&#8217;t matter whether you use a new passphrase for the converted key or keep it the same as the old key.</p>

<p>Not all software can read the PKCS8 format, but that&#8217;s fine &#8212; only your SSH client needs to be able to read the private key, after all. From the server&#8217;s point of view, storing the private key in a different format changes nothing at all.</p>
        </div>

        <div class="by-line">
            <address class="author vcard full-author">
                <span class="by">By</span> <a class="url fn" href="http://martin.kleppmann.com/">Martin Kleppmann</a>
            </address>
            <span class="date full-date">
                <abbr class="published" title="2013-05-24T00:00:00+01:00">24 May 2013</abbr>
            </span>
        </div>

        <p class="comments-link">
            <a href="/2013/05/24/improving-security-of-ssh-private-keys.html#disqus_thread">Comments</a>
        </p>

        <div class="clear"></div>
    </div>

    <div class="hentry full p1 post publish">
        <h1 class="entry-title full-title">
            <a href="/2012/12/05/schema-evolution-in-avro-protocol-buffers-thrift.html" rel="bookmark">Schema evolution in Avro, Protocol Buffers and Thrift</a>
        </h1>

        <div class="entry-content full-content">
            <p>So you have some data that you want to store in a file or send over the network. You may find yourself going through several phases of evolution:</p>

<ol>
<li>Using your programming language&#8217;s built-in serialization, such as <a href='http://docs.oracle.com/javase/6/docs/platform/serialization/spec/serialTOC.html'>Java serialization</a>, Ruby&#8217;s <a href='http://www.ruby-doc.org/core-1.9.3/Marshal.html'>marshal</a>, or Python&#8217;s <a href='http://docs.python.org/3.3/library/pickle.html'>pickle</a>. Or maybe you even invent your own format.</li>

<li>Then you realise that being locked into one programming language sucks, so you move to using a widely supported, language-agnostic format like JSON (or XML if you like to party like it&#8217;s 1999).</li>

<li>Then you decide that JSON is too verbose and too slow to parse, you&#8217;re annoyed that it doesn&#8217;t differentiate integers from floating point, and think that you&#8217;d quite like binary strings as well as Unicode strings. So you invent some sort of binary format that&#8217;s kinda like JSON, but binary (<a href='http://msgpack.org/'>1</a>, <a href='http://bsonspec.org/'>2</a>, <a href='http://ubjson.org/'>3</a>, <a href='http://bjson.org/'>4</a>, <a href='http://kaijaeger.com/articles/introducing-bison-binary-interchange-standard.html'>5</a>, <a href='https://github.com/voldemort/voldemort/wiki/Binary-JSON-Serialization'>6</a>).</li>

<li>Then you find that people are stuffing all sorts of random fields into their objects, using inconsistent types, and you&#8217;d quite like a <strong>schema</strong> and some <strong>documentation</strong>, thank you very much. Perhaps you&#8217;re also using a statically typed programming language and want to generate model classes from a schema. Also you realize that your binary JSON-lookalike actually isn&#8217;t all that compact, because you&#8217;re still storing field names over and over again; hey, if you had a schema, you could avoid storing objects&#8217; field names, and you could save some more bytes!</li>
</ol>

<p>Once you get to the fourth stage, your options are typically <a href='http://thrift.apache.org/'>Thrift</a>, <a href='http://code.google.com/p/protobuf/'>Protocol Buffers</a> or <a href='http://avro.apache.org/'>Avro</a>. All three provide efficient, cross-language serialization of data using a schema, and code generation for the Java folks.</p>

<p>Plenty of comparisons have been written about them already (<a href='http://floatingsun.net/articles/thrift-vs-protocol-buffers/'>1</a>, <a href='http://www.igvita.com/2011/08/01/protocol-buffers-avro-thrift-messagepack/'>2</a>, <a href='http://blog.mirthlab.com/2009/06/01/thrift-vs-protocol-bufffers-vs-json/'>3</a>, <a href='http://tech.puredanger.com/2011/05/27/serialization-comparison/'>4</a>). However, many posts overlook a detail that seems mundane at first, but is actually cruicial: <strong>What happens if the schema changes?</strong></p>

<p>In real life, data is always in flux. The moment you think you have finalised a schema, someone will come up with a use case that wasn&#8217;t anticipated, and wants to &#8220;just quickly add a field&#8221;. Fortunately Thrift, Protobuf and Avro all support <strong>schema evolution</strong>: you can change the schema, you can have producers and consumers with different versions of the schema at the same time, and it all continues to work. That is an extremely valuable feature when you&#8217;re dealing with a big production system, because it allows you to update different components of the system independently, at different times, without worrying about compatibility.</p>

<p>Which brings us to the topic of today&#8217;s post. I would like to explore how Protocol Buffers, Avro and Thrift actually encode data into bytes &#8212; and this will also help explain how each of them deals with schema changes. The design choices made by each of the frameworks are interesting, and by comparing them I think you can become a better engineer (by a little bit).</p>

<p>The example I will use is a little object describing a person. In JSON I would write it like this:</p>
<div class='highlight'><pre><code class='js'><span class='p'>{</span>
    <span class='s2'>&quot;userName&quot;</span><span class='o'>:</span> <span class='s2'>&quot;Martin&quot;</span><span class='p'>,</span>
    <span class='s2'>&quot;favouriteNumber&quot;</span><span class='o'>:</span> <span class='mi'>1337</span><span class='p'>,</span>
    <span class='s2'>&quot;interests&quot;</span><span class='o'>:</span> <span class='p'>[</span><span class='s2'>&quot;daydreaming&quot;</span><span class='p'>,</span> <span class='s2'>&quot;hacking&quot;</span><span class='p'>]</span>
<span class='p'>}</span>
</code></pre></div>
<p>This JSON encoding can be our baseline. If I remove all the whitespace it consumes 82 bytes.</p>

<h2 id='protocol_buffers'>Protocol Buffers</h2>

<p>The Protocol Buffers schema for the person object might look something like this:</p>

<pre><code>message Person {
    required string user_name        = 1;
    optional int64  favourite_number = 2;
    repeated string interests        = 3;
}</code></pre>

<p>When we <a href='https://developers.google.com/protocol-buffers/docs/encoding'>encode</a> the data above using this schema, it uses 33 bytes, as follows:</p>
<a href='/2012/12/protobuf.png'><img height='230' src='/2012/12/protobuf_small.png' width='550' /></a>
<p>Look exactly at how the binary representation is structured, byte by byte. The person record is just the concatentation of its fields. Each field starts with a byte that indicates its tag number (the numbers <code>1</code>, <code>2</code>, <code>3</code> in the schema above), and the type of the field. If the first byte of a field indicates that the field is a string, it is followed by the number of bytes in the string, and then the UTF-8 encoding of the string. If the first byte indicates that the field is an integer, a variable-length encoding of the number follows. There is no array type, but a tag number can appear multiple times to represent a multi-valued field.</p>

<p>This encoding has consequences for schema evolution:</p>

<ul>
<li>There is no difference in the encoding between <code>optional</code>, <code>required</code> and <code>repeated</code> fields (except for the number of times the tag number can appear). This means that you can change a field from <code>optional</code> to <code>repeated</code> and vice versa (if the parser is expecting an <code>optional</code> field but sees the same tag number multiple times in one record, it discards all but the last value). <code>required</code> has an additional validation check, so if you change it, you risk runtime errors (if the sender of a message thinks that it&#8217;s optional, but the recipient thinks that it&#8217;s required).</li>

<li>An <code>optional</code> field without a value, or a <code>repeated</code> field with zero values, does not appear in the encoded data at all &#8212; the field with that tag number is simply absent. Thus, it is safe to remove that kind of field from the schema. However, you must never reuse the tag number for another field in future, because you may still have data stored that uses that tag for the field you deleted.</li>

<li>You can add a field to your record, as long as it is given a new tag number. If the Protobuf parser parser sees a tag number that is not defined in its version of the schema, it has no way of knowing what that field is called. But it <em>does</em> roughly know what type it is, because a 3-bit type code is included in the first byte of the field. This means that even though the parser can&#8217;t exactly interpret the field, it can figure out how many bytes it needs to skip in order to find the next field in the record.</li>

<li>You can rename fields, because field names don&#8217;t exist in the binary serialization, but you can never change a tag number.</li>
</ul>

<p>This approach of using a tag number to represent each field is simple and effective. But as we&#8217;ll see in a minute, it&#8217;s not the only way of doing things.</p>

<h2 id='avro'>Avro</h2>

<p>Avro schemas can be written in two ways, either in a JSON format:</p>
<div class='highlight'><pre><code class='js'><span class='p'>{</span>
    <span class='s2'>&quot;type&quot;</span><span class='o'>:</span> <span class='s2'>&quot;record&quot;</span><span class='p'>,</span>
    <span class='s2'>&quot;name&quot;</span><span class='o'>:</span> <span class='s2'>&quot;Person&quot;</span><span class='p'>,</span>
    <span class='s2'>&quot;fields&quot;</span><span class='o'>:</span> <span class='p'>[</span>
        <span class='p'>{</span><span class='s2'>&quot;name&quot;</span><span class='o'>:</span> <span class='s2'>&quot;userName&quot;</span><span class='p'>,</span>        <span class='s2'>&quot;type&quot;</span><span class='o'>:</span> <span class='s2'>&quot;string&quot;</span><span class='p'>},</span>
        <span class='p'>{</span><span class='s2'>&quot;name&quot;</span><span class='o'>:</span> <span class='s2'>&quot;favouriteNumber&quot;</span><span class='p'>,</span> <span class='s2'>&quot;type&quot;</span><span class='o'>:</span> <span class='p'>[</span><span class='s2'>&quot;null&quot;</span><span class='p'>,</span> <span class='s2'>&quot;long&quot;</span><span class='p'>]},</span>
        <span class='p'>{</span><span class='s2'>&quot;name&quot;</span><span class='o'>:</span> <span class='s2'>&quot;interests&quot;</span><span class='p'>,</span>       <span class='s2'>&quot;type&quot;</span><span class='o'>:</span> <span class='p'>{</span><span class='s2'>&quot;type&quot;</span><span class='o'>:</span> <span class='s2'>&quot;array&quot;</span><span class='p'>,</span> <span class='s2'>&quot;items&quot;</span><span class='o'>:</span> <span class='s2'>&quot;string&quot;</span><span class='p'>}}</span>
    <span class='p'>]</span>
<span class='p'>}</span>
</code></pre></div>
<p>&#8230;or in an IDL:</p>

<pre><code>record Person {
    string               userName;
    union { null, long } favouriteNumber;
    array&lt;string&gt;        interests;
}</code></pre>

<p>Notice that there are no tag numbers in the schema! So how does it work?</p>

<p>Here is the same example data <a href='http://avro.apache.org/docs/current/spec.html'>encoded</a> in just 32 bytes:</p>
<a href='/2012/12/avro.png'><img height='259' src='/2012/12/avro_small.png' width='550' /></a>
<p>Strings are just a length prefix followed by UTF-8 bytes, but there&#8217;s nothing in the bytestream that tells you that it is a string. It could just as well be a variable-length integer, or something else entirely. The only way you can parse this binary data is by reading it alongside the schema, and the schema tells you what type to expect next. You need to have the <strong>exact same version</strong> of the schema as the writer of the data used. If you have the wrong schema, the parser will not be able to make head or tail of the binary data.</p>

<p>So how does Avro support schema evolution? Well, although you need to know the exact schema with which the data was written (the writer&#8217;s schema), that doesn&#8217;t have to be the same as the schema the consumer is expecting (the reader&#8217;s schema). You can actually give <em>two different</em> schemas to the Avro parser, and it uses <a href='http://avro.apache.org/docs/1.7.2/api/java/org/apache/avro/io/parsing/doc-files/parsing.html'>resolution rules</a> to translate data from the writer schema into the reader schema.</p>

<p>This has some interesting consequences for schema evolution:</p>

<ul>
<li>The Avro encoding doesn&#8217;t have an indicator to say which field is next; it just encodes one field after another, in the order they appear in the schema. Since there is no way for the parser to know that a field has been skipped, there is no such thing as an optional field in Avro. Instead, if you want to be able to leave out a value, you can use a union type, like <code>union { null, long }</code> above. This is encoded as a byte to tell the parser which of the possible union types to use, followed by the value itself. By making a union with the <code>null</code> type (which is simply encoded as zero bytes) you can make a field optional.</li>

<li>Union types are powerful, but you must take care when changing them. If you want to add a type to a union, you first need to update all readers with the new schema, so that they know what to expect. Only once all readers are updated, the writers may start putting this new type in the records they generate.</li>

<li>You can reorder fields in a record however you like. Although the fields are encoded in the order they are declared, the parser matches fields in the reader and writer schema by name, which is why no tag numbers are needed in Avro.</li>

<li>Because fields are matched by name, changing the name of a field is tricky. You need to first update all <em>readers</em> of the data to use the new field name, while keeping the old name as an alias (since the name matching uses aliases from the reader&#8217;s schema). Then you can update the writer&#8217;s schema to use the new field name.</li>

<li>You can add a field to a record, provided that you also give it a default value (e.g. <code>null</code> if the field&#8217;s type is a union with <code>null</code>). The default is necessary so that when a reader using the new schema parses a record written with the old schema (and hence lacking the field), it can fill in the default instead.</li>

<li>Conversely, you can remove a field from a record, provided that it previously had a default value. (This is a good reason to give all your fields default values if possible.) This is so that when a reader using the <em>old</em> schema parses a record written with the <em>new</em> schema, it can fall back to the default.</li>
</ul>

<p>This leaves us with the problem of knowing the exact schema with which a given record was written. The best solution depends on the context in which your data is being used:</p>

<ul>
<li>In Hadoop you typically have large files containing millions of records, all encoded with the same schema. <a href='http://avro.apache.org/docs/1.7.2/spec.html#Object+Container+Files'>Object container files</a> handle this case: they just include the schema once at the beginning of the file, and the rest of the file can be decoded with that schema.</li>

<li>In an RPC context, it&#8217;s probably too much overhead to send the schema with every request and response. But if your RPC framework uses long-lived connections, it can negotiate the schema once at the start of the connection, and amortize that overhead over many requests.</li>

<li>If you&#8217;re storing records in a database one-by-one, you may end up with different schema versions written at different times, and so you have to annotate each record with its schema version. If storing the schema itself is too much overhead, you can use a <a href='http://avro.apache.org/docs/1.7.2/spec.html#Schema+Fingerprints'>hash</a> of the schema, or a sequential schema version number. You then need a <a href='https://issues.apache.org/jira/browse/AVRO-1124'>schema registry</a> where you can look up the exact schema definition for a given version number.</li>
</ul>

<p>One way of looking at it: in Protocol Buffers, every field in a record is tagged, whereas in Avro, the entire record, file or network connection is tagged with a schema version.</p>

<p>At first glance it may seem that Avro&#8217;s approach suffers from greater complexity, because you need to go to the additional effort of distributing schemas. However, I am beginning to think that Avro&#8217;s approach also has some distinct advantages:</p>

<ul>
<li>Object container files are wonderfully self-describing: the writer schema embedded in the file contains all the field names and types, and even documentation strings (if the author of the schema bothered to write some). This means you can load these files directly into interactive tools like <a href='http://pig.apache.org/'>Pig</a>, and it Just Works™ without any configuration.</li>

<li>As Avro schemas are JSON, you can add your own metadata to them, e.g. describing application-level semantics for a field. And as you distribute schemas, that metadata automatically gets distributed too.</li>

<li>A schema registry is probably a good thing in any case, serving as <a href='https://github.com/ept/avrodoc'>documentation</a> and helping you to find and reuse data. And because you simply can&#8217;t parse Avro data without the schema, the schema registry is guaranteed to be up-to-date. Of course you can set up a protobuf schema registry too, but since it&#8217;s not <em>required</em> for operation, it&#8217;ll end up being on a best-effort basis.</li>
</ul>

<h2 id='thrift'>Thrift</h2>

<p>Thrift is a much bigger project than Avro or Protocol Buffers, as it&#8217;s not just a data serialization library, but also an entire RPC framework. It also has a somewhat different culture: whereas Avro and Protobuf standardize a single binary encoding, Thrift <a href='http://mail-archives.apache.org/mod_mbox/hadoop-general/200904.mbox/%3CC5FEF47F.90BAC%25cwalter%40microsoft.com%3E'>embraces</a> a whole variety of different serialization formats (which it calls &#8220;protocols&#8221;).</p>

<p>Indeed, Thrift has <a href='https://builds.apache.org//job/Thrift/javadoc/org/apache/thrift/protocol/TJSONProtocol.html'>two</a> <a href='https://builds.apache.org//job/Thrift/javadoc/org/apache/thrift/protocol/TSimpleJSONProtocol.html'>different</a> JSON encodings, and no fewer than three different binary encodings. (However, one of the binary encodings, DenseProtocol, is <a href='http://wiki.apache.org/thrift/LibraryFeatures'>only supported in the C++ implementation</a>; since we&#8217;re interested in cross-language serialization, I will focus on the other two.)</p>

<p>All the encodings share the same schema definition, in Thrift IDL:</p>

<pre><code>struct Person {
  1: string       userName,
  2: optional i64 favouriteNumber,
  3: list&lt;string&gt; interests
}</code></pre>

<p>The BinaryProtocol encoding is very straightforward, but also fairly wasteful (it takes 59 bytes to encode our example record):</p>
<a href='/2012/12/binaryprotocol.png'><img height='269' src='/2012/12/binaryprotocol_small.png' width='550' /></a>
<p>The CompactProtocol encoding is semantically equivalent, but uses variable-length integers and bit packing to reduce the size to 34 bytes:</p>
<a href='/2012/12/compactprotocol.png'><img height='276' src='/2012/12/compactprotocol_small.png' width='550' /></a>
<p>As you can see, Thrift&#8217;s approach to schema evolution is the same as Protobuf&#8217;s: each field is manually assigned a tag in the IDL, and the tags and field types are stored in the binary encoding, which enables the parser to skip unknown fields. Thrift defines an explicit list type rather than Protobuf&#8217;s repeated field approach, but otherwise the two are very similar.</p>

<p>In terms of philosophy, the libraries are very different though. Thrift favours the &#8220;one-stop shop&#8221; style that gives you an entire integrated RPC framework and many choices (with <a href='http://wiki.apache.org/thrift/LibraryFeatures'>varying cross-language support</a>), whereas Protocol Buffers and Avro appear to follow much more of a <a href='http://www.faqs.org/docs/artu/ch01s06.html'>&#8220;do one thing and do it well&#8221;</a> style.</p>

<p><em>This post has been translated into <a href='http://www.sjava.net/319'>Korean</a> by Justin Song.</em></p>
        </div>

        <div class="by-line">
            <address class="author vcard full-author">
                <span class="by">By</span> <a class="url fn" href="http://martin.kleppmann.com/">Martin Kleppmann</a>
            </address>
            <span class="date full-date">
                <abbr class="published" title="2012-12-05T00:00:00+00:00">05 Dec 2012</abbr>
            </span>
        </div>

        <p class="comments-link">
            <a href="/2012/12/05/schema-evolution-in-avro-protocol-buffers-thrift.html#disqus_thread">Comments</a>
        </p>

        <div class="clear"></div>
    </div>

    <div class="hentry full p1 post publish">
        <h1 class="entry-title full-title">
            <a href="/2012/10/08/complexity-of-user-experience.html" rel="bookmark">The complexity of user experience</a>
        </h1>

        <div class="entry-content full-content">
            <p>The problem of overly complex software is nothing new; it is almost as old as software itself. Over and over again, software systems become so complex that they become very difficult to maintain and very time-consuming and expensive to modify. Most developers hate working on such systems, yet nevertheless we keep creating new, overly complex systems all the time.</p>

<p>Much has been written about this, including classic papers by Fred Brooks (<a href='http://people.eecs.ku.edu/~saiedian/Teaching/Sp08/816/Papers/Background-Papers/no-silver-bullet.pdf'>No Silver Bullet</a>), and Ben Moseley and Peter Marks (<a href='http://shaffner.us/cs/papers/tarpit.pdf'>Out of the Tar Pit</a>). They are much more worth reading than this post, and it is presumptuous of me to think I could add anything significant to this debate. But I will try nevertheless.</p>

<p>Pretty much everyone agrees that if you have a choice between a simpler software design and a more complex design, all else being equal, that simpler is better. It is also widely thought to be worthwhile to deliberately invest in simplicity &#8212; for example, to spend effort refactoring existing code into a cleaner design &#8212; because the one-off cost of refactoring today is easily offset by the benefits of easier maintenance tomorrow. Also, much thought by many smart people has gone into finding ways of breaking down complex systems into manageable parts with manageable dependencies. I don&#8217;t wish to dispute any of that.</p>

<p>But there is a subtlety that I have been missing in discussions about software complexity, that I feel somewhat ambivalent about, and that I think is worth discussing. It concerns the points where external humans (people outside of the team maintaining the system) touch the system &#8212; as developers using an API exposed by the system, or as end users interacting with a user interface. I will concentrate mostly on user interfaces, but much of this discussion applies to APIs too.</p>

<h2 id='examples'>Examples</h2>

<p>Let me first give a few examples, and then try to extract a pattern from them. They are examples of situations where, if you want, you can go to substantial engineering effort in order to make a user interface a little bit nicer. (Each example based on a true story!)</p>

<ul>
<li>You have an e-commerce site, and need to send out order confirmation emails that explain next steps to the customer. Those next steps differ depending on availability, the tax status of the product, the location of the customer, the type of account they have, and a myriad other parameters. You want the emails to only include the information that is applicable to this particular customer&#8217;s situation, and not burden them with edge cases that don&#8217;t apply to them. You also want the emails to read as coherent prose, not as a bunch of fragmented bullet points generated by <code>if</code> statements based on the order parameters. So you go and build a natural language grammar model for constructing emails based on sentence snippets (providing pluralisation, agreement, declension in languages that have it, etc), in such a way that for any one out of 100 million possible parameter combinations, the resulting email is grammatically correct and easy to understand.</li>

<li>You have a multi-step user flow that is used in various different contexts, but ultimatively achieves the same thing in each context. (For example, <a href='http://rapportive.com/'>Rapportive</a> has several OAuth flows for connecting your account with various social networks, and there are several different buttons in different places that all lead into the same user flow.) The simple solution is to make the flow generic, and not care how the user got there. But if you want to make the user feel good, you need to imagine what state their mind was in when they entered the flow, and customise the images, text and structure of the flow in order to match their goal. This means you have to keep track of where the user came from, what they were trying to do, and thread that context through every step of the flow. This is not fundamentally hard, but it is fiddly, time-consuming and error-prone.</li>

<li>You have an application that requires some arcane configuration. You could take the stance that you will give the user a help page and they will have to figure it out from there. Or you could write a sophisticated auto-configuration tool that inspects the user&#8217;s environment, analyses thousands of possible software combinations and configurations (and updates this database as new versions of other products in the environment are released), and automatically chooses the correct settings &#8212; hopefully without having to ask the user for help. With auto-configuration, the users never even know that they were spared a confusing configuration dialog. But somehow, word gets around that the product &#8220;just works&#8221;.</li>
</ul>

<h2 id='whats_a_user_requirement'>What&#8217;s a user requirement?</h2>

<p>We said above that simplicity is good. However, taking simplicity to an exaggerated extreme, you end up with software that does nothing. This implies that there are aspects of software complexity that are <strong>essential</strong> to the user&#8217;s problem that is being solved. (Note that I don&#8217;t mean complexity of the user interface, but complexity of the actual code that implements the solution to the user&#8217;s problem.)</p>

<p>Unfortunately, there is a lot of additional complexity introduced by stuff that is not directly visible or useful to users: stuff that is only required to &#8220;grease the wheels&#8221;, for example to make legacy components work or to improve performance. Moseley and Marks call this latter type <strong>accidental</strong> complexity, and argue that it should be removed or abstracted away as much as possible. (Other authors define essential and accidental complexity slightly differently, but the exact definition is not important for the purpose of this post.)</p>

<p>This suggests that it is important to understand what <strong>user problem</strong> is being solved, and that&#8217;s where things start getting tricky. When you say that something is essential because it fulfils a <strong>user requirement</strong> (as opposed to an implementation constraint or a performance optimisation), that presupposes a very utilitarian view of software. It assumes that the user is trying to get a job done, and that they are a rational actor. But what if, say, you are taking an emotional approach and optimising for <strong>user delight</strong>?</p>

<p>What if the user didn&#8217;t know they had a problem, but you solve it anyway? If you introduce complexity in the system for the sake of making things a little nicer for the user (but without providing new core functionality), is that complexity really essential? What if you add a little detail that is surprising but delightful?</p>

<p>You can try to reduce an emotional decision down to a rational one &#8212; for example, you can say that when a user plays a game, it is solving the user&#8217;s problem of boredom by providing distraction. Thus any feature which substantially contributes towards alleviating boredom may be considered essential. Such reductionism can sometimes provide useful angles of insight, but I think a lot would be lost by ignoring the emotional angle.</p>

<p>You can state categorically that &#8220;great user experience is an essential feature&#8221;. But what does that mean? By itself, that statement is so general that could be used to argue for anything or nothing. User experience is subjective. What&#8217;s preferable for one user may be an annoyance for another user, even if both users are in the application&#8217;s target segment. Sometimes it just comes down to taste or fashion. User experience tends to have an emotional angle that makes it hard to fit into a rational reasoning framework.</p>

<p>What I am trying to get at: there are things in software that introduce a lot of complexity (and that we should consequently be wary of), and that can&#8217;t be directly mapped to a bullet point on a list of user requirements, but that are nevertheless important and valuable. These things do not necessarily provide important functionality, but they contribute to how the user <strong>feels</strong> about the application. Their effect may be invisible or subconscious, but that doesn&#8217;t make them any less essential.</p>

<h2 id='datadriven_vs_emotional_design'>Data-driven vs. emotional design</h2>

<p>Returning to the examples above: as an application developer, you can choose whether to take on substantial additional complexity in the software in order to simplify or improve the experience for the user. The increased software complexity actually <strong>reduces</strong> the complexity from the user&#8217;s point of view. These examples also illustrate how user experience concerns are not just a matter of graphic design, but can also have a big impact on how things are engineered.</p>

<p>The features described above arguably do not contribute to the utility of the software &#8212; in the e-commerce example, orders will be fulfilled whether or not the confirmation emails are grammatical. In that sense, the complexity is unnecessary. But I would argue that these kind of user experience improvements are just as important as the utility of the product, because they determine how users <strong>feel</strong> about it. And how they feel ultimately determines whether they come back, and thus the success or failure of the product.</p>

<p>One could even argue that the utility of a product is a subset of its user experience: if the software doesn&#8217;t do the job that it&#8217;s supposed to, then that&#8217;s one way of creating a pretty bad experience; however, there are also many other ways of creating a bad experience, while remaining fully functional from a utilitarian point of view.</p>

<p>The emotional side of user experience can be a difficult thing for organisations to grapple with, because it doesn&#8217;t easily map to metrics. You can measure things like how long a user stayed on your site, how many things they clicked on, conversion rates, funnels, repeat purchase rates, lifetime values&#8230; but those numbers tell you very little about how happy you made a user. So you can take a &#8220;data-driven&#8221; approach to design decisions and say that a feature is worthwhile if and only if it makes the metrics go up &#8212; but I fear that an important side of the story is missed if you go solely by the numbers.</p>

<h2 id='questions'>Questions</h2>

<p>This is as far as my thinking has got: believing that a great user experience is essential for many products; and recognising that building a great UX is hard, can require substantial additional complexity in engineering, and can be hard to justify in terms of logical arguments and metrics. Which leaves me with some unanswered questions:</p>

<ul>
<li>Every budget is finite, so you have to prioritise things, and not everything will get done. When you consider building something that improves user experience without strictly adding utility, it has to be traded off against features that do add utility (is it better to shave a day off the delivery time than to have a nice confirmation email?), and the cost of the increased complexity (will that clever email generator be a nightmare to localise when we translate the site into other languages?). How do you decide about that kind of trade-offs?</li>

<li>User experience choices are often emotional and <a href='http://martin.kleppmann.com/2010/10/30/intuition-has-no-transfer-encoding.html'>intuitive</a> (no number of focus groups and usability tests can replace good taste). That doesn&#8217;t make them any more or less important than rational arguments, but combining emotional and rational arguments can be tricky. Emotionally-driven people tend to let emotional choices overrule rational arguments, and rationally-driven people vice versa. How do you find the healthy middle ground?</li>

<li>If you&#8217;re aiming for a minimum viable product in order to test out a market (as opposed to improving a mature product), does that change how you prioritise core utility relative to &#8220;icing on the cake&#8221;?</li>
</ul>

<p>I suspect that the answers to the questions above are <em>&#8220;it depends&#8221;</em>. More precisely, <em>&#8220;how one thing is valued relative to another is an aspect of your particular organisation&#8217;s culture, and there&#8217;s no one right answer&#8221;</em>. That would imply that each of us should think about it; you should have your own personal answers for how you decide these things in your own projects, and be able to articulate them. But it&#8217;s difficult &#8212; I don&#8217;t think hard-and-fast rules have a chance of working here.</p>

<p>I&#8217;d love to hear your thoughts in the comments below. If you liked this post, you can <a href='http://eepurl.com/csJmf'>subscribe to email notifications</a> when I write something new :)</p>
        </div>

        <div class="by-line">
            <address class="author vcard full-author">
                <span class="by">By</span> <a class="url fn" href="http://martin.kleppmann.com/">Martin Kleppmann</a>
            </address>
            <span class="date full-date">
                <abbr class="published" title="2012-10-08T00:00:00+01:00">08 Oct 2012</abbr>
            </span>
        </div>

        <p class="comments-link">
            <a href="/2012/10/08/complexity-of-user-experience.html#disqus_thread">Comments</a>
        </p>

        <div class="clear"></div>
    </div>

    <div class="hentry full p1 post publish">
        <h1 class="entry-title full-title">
            <a href="/2012/10/01/rethinking-caching-in-web-apps.html" rel="bookmark">Rethinking caching in web apps</a>
        </h1>

        <div class="entry-content full-content">
            <p>Having spent a lot of the last few years worrying about the scalability of data-heavy applications like <a href='http://rapportive.com/'>Rapportive</a>, I have started to get the feeling that maybe we have all been &#8220;doing it wrong&#8221;. Maybe what we consider to be &#8220;state of the art&#8221; application architecture is actually holding us back.</p>

<p>I don&#8217;t have a definitive answer for how we should be architecting things differently, but in this post I&#8217;d like to outline a few ideas that I have been fascinated by recently. My hope is that we can develop ways of better managing scale (in terms of complexity, volume of data and volume of traffic) while keeping our applications nimble, easy and safe to modify, test and iterate.</p>

<p>My biggest problem with web application architecture is how <strong>network communication concerns</strong> are often intermingled with <strong>business logic concerns</strong>. This makes it hard to rearrange the logic into new architectures, such as the precomputed cache architecture described below. In this post I explore why it important to be able to try new architectures for things like caching, and what it would take to achieve that flexibility.</p>

<h2 id='an_example'>An example</h2>

<p>To illustrate, consider the clichéd Rails blogging engine example:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>Post</span> <span class='o'>&lt;</span> <span class='ss'>ActiveRecord</span><span class='p'>:</span><span class='ss'>:Base</span>
  <span class='n'>attr_accessible</span> <span class='ss'>:title</span><span class='p'>,</span> <span class='ss'>:content</span><span class='p'>,</span> <span class='ss'>:author</span>
  <span class='n'>has_many</span> <span class='ss'>:comments</span>
<span class='k'>end</span>

<span class='k'>class</span> <span class='nc'>Comment</span> <span class='o'>&lt;</span> <span class='ss'>ActiveRecord</span><span class='p'>:</span><span class='ss'>:Base</span>
  <span class='n'>attr_accessible</span> <span class='ss'>:content</span><span class='p'>,</span> <span class='ss'>:author</span>
  <span class='n'>belongs_to</span> <span class='ss'>:post</span>
<span class='k'>end</span>

<span class='k'>class</span> <span class='nc'>PostsController</span> <span class='o'>&lt;</span> <span class='no'>ApplicationController</span>
  <span class='k'>def</span> <span class='nf'>show</span>
    <span class='vi'>@post</span> <span class='o'>=</span> <span class='no'>Post</span><span class='o'>.</span><span class='n'>find</span><span class='p'>(</span><span class='n'>params</span><span class='o'>[</span><span class='ss'>:id</span><span class='o'>]</span><span class='p'>)</span>
    <span class='n'>respond_to</span> <span class='k'>do</span> <span class='o'>|</span><span class='nb'>format</span><span class='o'>|</span>
      <span class='nb'>format</span><span class='o'>.</span><span class='n'>html</span>  <span class='c1'># show.html.erb</span>
      <span class='nb'>format</span><span class='o'>.</span><span class='n'>json</span>  <span class='p'>{</span> <span class='n'>render</span> <span class='ss'>:json</span> <span class='o'>=&gt;</span> <span class='vi'>@post</span> <span class='p'>}</span>
    <span class='k'>end</span>
  <span class='k'>end</span>
<span class='k'>end</span>

<span class='c1'># posts/show.html.erb:</span>
</code></pre></div>
<p><div class='highlight'><pre><code class='html+erb'><span class='nt'>&lt;h1&gt;</span><span class='cp'>&lt;%=</span> <span class='vi'>@post</span><span class='o'>.</span><span class='n'>title</span> <span class='cp'>%&gt;</span><span class='nt'>&lt;/h1&gt;</span>
<span class='nt'>&lt;p</span> <span class='na'>class=</span><span class='s'>&quot;author&quot;</span><span class='nt'>&gt;</span>By <span class='cp'>&lt;%=</span> <span class='vi'>@post</span><span class='o'>.</span><span class='n'>author</span> <span class='cp'>%&gt;</span><span class='nt'>&lt;/p&gt;</span>
<span class='nt'>&lt;div</span> <span class='na'>class=</span><span class='s'>&quot;content&quot;</span><span class='nt'>&gt;</span>
  <span class='cp'>&lt;%=</span> <span class='n'>simple_format</span><span class='p'>(</span><span class='vi'>@post</span><span class='o'>.</span><span class='n'>content</span><span class='p'>)</span> <span class='cp'>%&gt;</span>
<span class='nt'>&lt;/div&gt;</span>
<span class='nt'>&lt;h2&gt;</span>Comments<span class='nt'>&lt;/h2&gt;</span>
<span class='nt'>&lt;ul</span> <span class='na'>class=</span><span class='s'>&quot;comments&quot;</span><span class='nt'>&gt;</span>
  <span class='cp'>&lt;%</span> <span class='vi'>@post</span><span class='o'>.</span><span class='n'>comments</span><span class='o'>.</span><span class='n'>each</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>comment</span><span class='o'>|</span> <span class='cp'>%&gt;</span>
    <span class='nt'>&lt;li&gt;</span>
      <span class='nt'>&lt;blockquote&gt;</span><span class='cp'>&lt;%=</span> <span class='n'>simple_format</span><span class='p'>(</span><span class='n'>comment</span><span class='o'>.</span><span class='n'>content</span><span class='p'>)</span> <span class='cp'>%&gt;</span><span class='nt'>&lt;/blockquote&gt;</span>
      <span class='nt'>&lt;p</span> <span class='na'>class=</span><span class='s'>&quot;author&quot;</span><span class='nt'>&gt;</span><span class='cp'>&lt;%=</span> <span class='n'>comment</span><span class='o'>.</span><span class='n'>author</span> <span class='cp'>%&gt;</span><span class='nt'>&lt;/p&gt;</span>
    <span class='nt'>&lt;/li&gt;</span>
  <span class='cp'>&lt;%</span> <span class='k'>end</span> <span class='cp'>%&gt;</span>
<span class='nt'>&lt;/ul&gt;</span>
</code></pre></div></p>

<p>Pretty good code by various standards, but it has always irked me a bit that I can&#8217;t see where the network communication (i.e. making database queries) is happening. When I look at that <code>Post.find</code> in the controller, I can guess that probabably translates into a <code>SELECT * FROM posts WHERE id = ?</code> internally &#8211; unless the same query was already made recently, and ActiveRecord cached the result. And another database query of the form <code>SELECT * FROM comments WHERE post_id = ?</code> might be made as a result of the <code>@post.comments</code> call in the template. Or maybe the comments were already previously loaded by some model logic, and then cached? Or someone decided to eagerly load comments with the original post? Who knows.</p>

<p>The execution flow for a MVC framework request like <code>PostsController#show</code> probably looks something like this:</p>
<p><a href='/2012/10/architecture-high-01.png'><img alt='Typical MVC request flow' height='119' src='/2012/10/architecture-01.png' width='550' /></a></p>
<p>Of course it is deliberately designed that way. Your template and your controller shouldn&#8217;t have to worry about database queries &#8212; those are encapsulated by the model for many good reasons. I am violating abstraction by even thinking about the database whilst I&#8217;m in the template code! I should just think of my models as pure, beautiful pieces of application state. How that state gets loaded from a database is a matter that only the models need to worry about.</p>

<h2 id='adding_complexity'>Adding complexity</h2>

<p>In the example above, the amount of logic in the model is minimal, but it typically doesn&#8217;t stay that way for long. As the application becomes popular (say, the blogging engine morphs to become Twitter, Tumblr, Reddit or Pinterest), all sorts of stuff gets added: memcache to stop the database from falling over, spam filtering, analytics features, email sending, notifications, A/B testing, more memcache, premium features, ads, upsells for viral loops, more analytics, even more memcache. As the application inevitably grows in complexity, the big monolithic beast is split into several smaller services, and different services end up being maintained by different teams.</p>

<p>As all of this is happening, the programming model typically stays the same: each service in the architecture (which may be a user-facing web server, or an internal service e.g. for user authentication) communicates over the network with a bunch of other nodes (memcached instances, database servers, other application services), processes and combines the data in some way, and then serves it out to a client.</p>

<p>That processing and combining of data we can abstractly call &#8220;business logic&#8221;. It might be trivially simple, or it might involve half a million lines of parsing, rendering or machine learning code. It might behave differently depending on which A/B test bucket the user is in. It might deal with hundreds of hairy edge cases. Whatever.</p>

<p>At the root of the matter, business logic should be a <a href='http://en.wikipedia.org/wiki/Pure_function'>pure function</a>. It takes a bunch of inputs (request parameters from the client, data stored in various databases and caches, responses from various other services) and produces a bunch of outputs (data to return to the client, data to write back to various databases and caches). It is usually deterministic: given the same inputs, the business logic should produce exactly the same output again. It is also stateless: any data that is required to produce the output or to make a decision has to be provided as an input.</p>

<p>By contrast, the network communication logic is all about &#8216;wiring&#8217;. It may end up having a lot of complexity in its own right: sending requests to the right node of a sharded database, retrying failed requests with exponential back-off, making requests to different services in parallel, cross-datacenter failover, service authentication, etc. But the network communication logic ought to be general-purpose and completely independent of your application&#8217;s business logic.</p>

<p>Both business logic and network communication logic are needed to build a service. But how do you combine the two into a single process? Most commonly, we build abstractions for each type of logic, hiding the gory implementation details. Much like in the blog example above, you end up calling a method somewhere inside the business logic, not really knowing or caring whether it will immediately return a value that the object has already computed, or whether it will talk to another process on the same machine, or load the value from some remote cache, or make a query on a database cluster somewhere.</p>

<p>It&#8217;s good that the business logic doesn&#8217;t need to worry about how and when the communication happens. And it&#8217;s good that the communication logic is general-purpose and not polluted with application-specific concerns. But I think it&#8217;s problematic that network communication may happen somewhere deeply inside a business logic call stack. Let me try to explain why.</p>

<h2 id='precomputed_caches'>Precomputed caches</h2>

<p>As your volume of data and your number of users grow, database access often becomes a bottleneck (there are more queries competing for I/O, and each query takes longer when there&#8217;s more data). The standard answer to the problem is of course caching. You can cache at many different levels: an individual database row, or a model object generated by combining several sources, or even an entire HTML page ready to serve to a client. I will focus on the mid-to-high-level caches, where the raw data has gone through some sort of business logic before it ends up in the cache.</p>

<p>Most commonly, caches are set up in read-through style: on every query, you first check the cache, and return the value from the cache if it&#8217;s a hit; otherwise it&#8217;s a miss, so you do whatever is required to generate the value (query databases, apply business logic, perform voodoo), and return it to the client whilst also storing it in the cache for next time. As long as you can generate the value on the fly in a reasonable time, this works pretty well.</p>

<p>I will gloss over cache invalidation and expiry for now, and return to it below.</p>

<p>The most apparent problem with a read-through cache is that the first time a value is requested, it&#8217;s always slow. (And if your cache is too small to hold the entire dataset, rarely accessed values will get evicted and thus be slow every time.) That may or may not be a problem for you. One reason why it may be a problem is that on many sites, the first client to request a given page is typically the Googlebot, and Google <a href='http://www.mattcutts.com/blog/site-speed/'>penalises</a> slow sites in rankings. So if you have the kind of site where Google juice is lifeblood, then your SEO guys may tell you that a read-through cache is not good enough.</p>

<p>So, can you make sure that the data is in the cache even before it is requested for the first time? Well, if your dataset isn&#8217;t too huge, you can actually <strong>precompute every possible cache entry</strong>, put them in a big distributed key-value store and serve them with minimal latency. That has a great advantage: cache misses no longer exist. If you&#8217;ve precomputed every possible cache entry, and a key isn&#8217;t in the cache, you can be sure that there&#8217;s no data for that key.</p>

<p>If that sounds crazy to you, consider these points:</p>

<ul>
<li>A database index is a special case of a precomputed cache. For every value you might want to search for, the index tells you where to find occurrences of that value. If it&#8217;s not in the index, it&#8217;s not in the database. The initial index creation is a one-off batch job, and thereafter the database automatically keeps it in sync with the raw data. Yes, databases have been doing this for a long time.</li>

<li>With Hadoop you can process terabytes of data without breaking a sweat. That is truly awesome power.</li>

<li>There are several datastores that allow you to precompute their files in Hadoop, which makes them very well suited for serving the cache that you precomputed. We are currently using <a href='http://www.project-voldemort.com/voldemort/'>Voldemort</a> in read-only mode (<a href='http://static.usenix.org/events/fast12/tech/full_papers/Sumbaly.pdf'>research paper</a>), but <a href='http://hbase.apache.org/book/arch.bulk.load.html'>HBase</a> and <a href='https://github.com/nathanmarz/elephantdb'>ElephantDB</a> can do this too.</li>

<li>If you&#8217;re currently storing data in denormalized form (to avoid joins on read queries), you can stop doing that. You can keep your primary database in a very clean, normalized schema, and any caches you derive from it can denormalize the data to your heart&#8217;s content. This gives you the best of both worlds.</li>
</ul>

<h2 id='separating_communication_from_business_logic'>Separating communication from business logic</h2>

<p>Ok, say you&#8217;ve decided that you want to precompute a cache in Hadoop. As we&#8217;ve not yet addressed cache invalidation (see below), let&#8217;s just say you&#8217;re going to rebuild the entire cache once a day. That means the data you serve out of the cache will be stale, out of date by up to a day, but that&#8217;s still acceptable for some applications.</p>

<p>The first step is to get your raw data into HDFS. That&#8217;s not hard, assuming you have daily database backups: you can take your existing backup, transform it into a more MapReduce-friendly format such as <a href='http://avro.apache.org/'>Avro</a>, and write it straight to HDFS. Do that with all your production databases and you&#8217;ve got a fantastic resource to work with in Hadoop.</p>

<p>Now, to build your precomputed cache, you need to apply the same business logic to the same data as you would in an uncached service that does it on the fly. As described above, your business logic takes as input the request parameters from the user and any data that is loaded from databases or services in order to serve that request. If you have all that data in HDFS, and you can work out all possible request parameters, then in theory, you should be able to take your existing business logic implementation and run it in Hadoop.</p>

<p>Business logic can be very complex, so you should probably aim to reuse the existing implementation rather than rewriting it. But doing so requires untangling the real business logic from all the network communication logic.</p>

<p>When your business logic is running as a service processing individual requests, you&#8217;re used to making several small requests to databases, caches or other services as part of generating a response (see the blog example above). Those small requests constitute gathering all the inputs needed by the business logic in order to produce its output (e.g. a rendered HTML page).</p>

<p>But when you&#8217;re running in Hadoop, this is all turned on its head. You don&#8217;t want to be making individual random-access requests to data, because that would be an order of magnitude too slow. Instead you need to use MapReduce to gather all the inputs for one particular evaluation of the business logic into one place, and then run the business logic given those inputs without any network communication. Rather than the business logic <em>pulling</em> together all the bits of data it needs in order to produce a response, the MapReduce job has already gathered all the data it knows the business logic is going to need, and <em>pushes</em> it into the business logic function.</p>

<p>Let&#8217;s use the blog example to make this more concrete. The data dependency is fairly simple: when the blog post <code>params[:id]</code> is requested, we require the row in the <code>posts</code> table whose <code>id</code> column matches the requested post, and we require all the rows in the <code>comments</code> table whose <code>post_id</code> column matches the requested post. If the <code>posts</code> and <code>comments</code> tables are in HDFS, it&#8217;s a very simple MapReduce job to group together the post with <code>id = x</code> and all the comments with <code>post_id = x</code>.</p>

<p>We can then use a stub database implementation to feed those database rows into the existing <code>Post</code> and <code>Comment</code> model objects. That way we can make the models think that they loaded the data from a database, even though actually we had already gathered all the data we knew it was going to need. The model objects can keep doing their job as normally, and the output they produce can be written straight to the cache.</p>

<p>By this point, two problems should be painfully clear:</p>

<ul>
<li>How does the MapReduce job know what inputs the business logic is going to need in order to work?</li>

<li>OMG, implementing stub database drivers, isn&#8217;t that a bit too much pain for limited gain? (Note that in testing frameworks it&#8217;s not unusual to stub out your database, so that you can run your unit tests without a real database. Still, it&#8217;s non-trivial and annoying.)</li>
</ul>

<p>Both problems have the same cause, namely that the network communication logic is triggered from deep inside the business logic.</p>

<h2 id='data_dependencies'>Data dependencies</h2>

<p>When you look at the business logic in the light of precomputing a cache, it seems like the following pattern would make more sense:</p>

<ol>
<li>Declare your data dependencies: &#8220;if you want me to render the blog post with ID <code>x</code>, I&#8217;m going to need the row in the <code>posts</code> table with <code>id = x</code>, and also all the rows in the <code>comments</code> table with <code>post_id = x</code>&#8221;.</li>

<li>Let the communication logic deal with resolving those dependencies. If you&#8217;re running as a normal web app, that means making database (or memcache) queries to one or more databases, and maybe talking to other services. If you&#8217;re running in Hadoop, it means configuring the MapReduce job to group together all the pieces of data on which the business logic depends.</li>

<li>Once all the dependencies have been loaded, the business logic is now a pure function, deterministic and side-effect-free, that produces our desired output. It can perform whatever complicated computation it needs to, but it&#8217;s not allowed access to the network or data stores that weren&#8217;t declared as dependencies up front.</li>
</ol>

<p>This separation would make application architecture very different from the way it is commonly done today. I think this new style would have several big advantages:</p>

<ul>
<li>By removing the assumption that the business logic is handling one request at a time, it becomes much easier to run the business logic in completely different contexts, such as in a batch job to precompute a cache. (No more stubbing out database drivers.)</li>

<li>Testing becomes much easier. All the tricky business logic for which you want to write unit tests is now just a function with a bunch of inputs and a bunch of outputs. You can easily vary what you put in, and easily check that the right thing comes out. Again, no more stubbing out the database.</li>

<li>The network communication logic can become a lot more helpful. For example, it can make several queries in parallel without burdening the business logic with a lot of complicated concurrency stuff, and it can deduplicate similar requests.</li>

<li>Because the data dependencies are very clearly and explicitly modelled, the system becomes easier to understand, and it becomes easier to move modules around, split a big monolithic beast into smaller services, or combine smaller services into bigger, logical units.</li>
</ul>

<p>I hope you agree that this is a very exciting prospect. But is it practical?</p>

<p>In most cases, I think it would not be very hard to make business logic pure (i.e. stop making database queries from deep within) &#8212; it&#8217;s mostly a matter of refactoring. I have done it to substantial chunks of the Rapportive code base, and it was a bit tedious but perfectly doable. And the network communication logic wouldn&#8217;t have to change much at all.</p>

<p>The problem of making this architecture practical hinges on having a good mechanism for declaring data dependencies. The idea is not new &#8212; for instance, LinkedIn have an internal framework for resolving data dependencies that queries several services in parallel &#8212; but I&#8217;ve not yet seen a language or framework that really gets to the heart of the problem.</p>

<p>Adapting the blog example above, this is what I imagine such an architecture would look like:</p>
<p><a href='/2012/10/architecture-high-02.png'><img alt='Concept for using a dependency resolver' height='119' src='/2012/10/architecture-02.png' width='550' /></a></p>
<p>We still have models, and they are still used as encapsulations of state, but they are no longer wrappers around a database connection. Instead, the dependency resolver can take care of the messy business of talking to the database; the models are pure and can focus on the business logic. The models don&#8217;t care whether they are instantiated in a web app or in a Hadoop cluster, and they don&#8217;t care whether the data was loaded from a SQL database or from HDFS. That&#8217;s the way it should be.</p>

<p>In my spare time I have started working on a language called <strong>Flowquery</strong> (don&#8217;t bother searching, there&#8217;s nothing online yet) to solve the problem of declaring data dependencies. If I can figure it out, it should make precomputed caches and all the good things above very easy. But it&#8217;s not there yet, so I don&#8217;t want to oversell it.</p>

<p>But wait, there is one more thing&#8230;</p>

<h2 id='cache_invalidation'>Cache invalidation</h2>

<blockquote>
<p>There are only two hard things in Computer Science: cache invalidation and naming things. &#8212; <a href='http://martinfowler.com/bliki/TwoHardThings.html'>Phil Karlton</a></p>
</blockquote>

<p>How important is it that the data in your cache is up-to-date and consistent with your &#8220;source of truth&#8221; database? The answer depends on the application and the circumstances. For example, if the user edits their own data, you almost certainly want to show them an up-to-date version of their own data post-editing, otherwise they will assume that your app is broken. But you might be able to get away with showing stale data to other users for a while. For data that is not directly edited by users, stale data may always be ok.</p>

<p>If staleness is acceptable, caching is fairly simple: on a read-through cache you set an expiry time on a cache key, and when that time is reached, the entry falls out of the cache. On a precomputed cache you do nothing, and just wait until the next time you recompute the entire thing.</p>

<p>In cases where greater consistency is required, you have to explicitly invalidate cache entries when the original data changes. If just one cache key is affected by a change, you can write-through to that cache key when the &#8220;source of truth&#8221; database is updated. If many keys may be affected, you can use <a href='http://37signals.com/svn/posts/3113-how-key-based-cache-expiration-works'>generational caching</a> and <a href='https://groups.google.com/forum/#!msg/memcached/OiScvRbGaU8/C1vny7DiGakJ'>clever generalisations thereof</a>. Whatever technique you use, it usually ends up being a lot of manually written, fiddly and error-prone code. Not a great joy to work with, hence the terribly clichéd quote above.</p>

<p>But&#8230; observe the following: in our efforts to separate pure business logic from network communication logic, we decided that we needed to explicitly model the data dependencies, and only data sources declared there are permitted as inputs to the business logic. In other words, the data dependency framework knows exactly which pieces of data are required in order to generate a particular piece of output &#8212; and conversely, when a piece of (input) data changes, it can know exactly which outputs (cache entries) may be affected by the change!</p>

<p>This means that if we have a real-time feed of changes to the underlying databases, we can feed it into a stream processing framework like <a href='http://storm-project.net/'>Storm</a>, run the data dependency analysis in reverse on every change, recompute the business logic for each output affected by the change in input, and write the results to another datastore. This store sits alongside the precomputed cache we generated in a batch process in Hadoop. When you want to query the cache, check both the output of the batch process and the output of the stream process. If the stream process has generated more recent data, use that, otherwise use the batch process output.</p>

<p>If you&#8217;ve been following recent news in Big Data, you may recognise this as an application of Nathan Marz&#8217; <a href='http://nathanmarz.com/blog/how-to-beat-the-cap-theorem.html'>lambda architecture</a> (described in detail in his <a href='http://www.manning.com/marz/'>upcoming book</a>). I cannot thank Nathan enough for his amazing work in this area.</p>

<p>In this architecture, you get the benefits of a precomputed cache (every request is fast, including the first one), it keeps itself up-to-date with the underlying data, and because you have already declared your data dependencies, you don&#8217;t need to manually write cache invalidation code! The same dependency declaration can be used in three different ways:</p>

<ol>
<li>In &#8216;online&#8217; mode in a service or web app, for driving the network communication logic in order to make all the required queries and requests in order to serve an incoming request, and to help with read-through caching.</li>

<li>In &#8216;offline&#8217; mode in Hadoop, to configure a MapReduce pipeline that brings together all the required data in order to run it through the business logic and generate a precomputed cache of all possible queries.</li>

<li>In &#8216;nearline&#8217; mode in Storm, to configure a stream processing topology that tracks changes to the underlying data, determines which cache keys need to be invalidated, and recomputes the cache values for those keys using the business logic.</li>
</ol>

<p>I am designing Flowquery so that it can be used in all three modes &#8212; you should be able to write your data dependencies just once, and let the framework take care of bringing all the necessary data together so that the business logic can act on it.</p>

<p>My hope is to make caching and cache invalidation as simple as database indexes. You declare an index once, the database runs a one-off batch job to build the index, and thereafter automatically keeps it up-to-date as the table contents change. It&#8217;s so simple to use that we don&#8217;t even think about it, and that&#8217;s what we should be aiming for in the realm of caching.</p>

<p>The project is still at a very early stage, but hopefully I&#8217;ll be posting more about it as it progresses. If you&#8217;d like to hear more, please <a href='http://eepurl.com/csJmf'>leave your email address</a> and I&#8217;ll send you a brief note when I post more. Or you can follow me on <a href='https://twitter.com/martinkl'>Twitter</a> or <a href='https://alpha.app.net/martinkl'>App.net</a>.</p>

<p><em>Thanks to Nathan Marz, Pete Warden, Conrad Irwin, Rahul Vohra and Sam Stokes for feedback on drafts of this post.</em></p>
        </div>

        <div class="by-line">
            <address class="author vcard full-author">
                <span class="by">By</span> <a class="url fn" href="http://martin.kleppmann.com/">Martin Kleppmann</a>
            </address>
            <span class="date full-date">
                <abbr class="published" title="2012-10-01T00:00:00+01:00">01 Oct 2012</abbr>
            </span>
        </div>

        <p class="comments-link">
            <a href="/2012/10/01/rethinking-caching-in-web-apps.html#disqus_thread">Comments</a>
        </p>

        <div class="clear"></div>
    </div>


        </div>
            <div id="sidebar">
        <div id="carrington-subscribe" class="widget">
            <h2 class="widget-title">Subscribe</h2>
            <a class="feed" title="RSS 2.0 feed for posts" rel="alternate" href="http://feeds.feedburner.com/martinkl">
                Site <acronym title="Really Simple Syndication">RSS</acronym> feed
            </a>

            <div id="mc_embed_signup">
                <p>
                    Enjoyed this? To get notified when I write something new,
                    <a href="http://twitter.com/martinkl">follow me</a> on Twitter,
                    <a href="http://feeds.feedburner.com/martinkl">subscribe</a> to the RSS feed,
                    or type in your email address:
                </p>

                <form action="http://rapportive.us2.list-manage.com/subscribe/post?u=9a1adaf549282981a96e171d1&amp;id=4543b695f6"
                    method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank">
                    <fieldset>
                        <div class="mc-field-group">
                            <label for="mce-EMAIL">Email:</label>
                            <input type="text" value="" name="EMAIL" class="required email" id="mce-EMAIL">
                            <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="btn">
                        </div>
                        <div id="mce-responses">
                            <div class="response" id="mce-error-response" style="display:none"></div>
                            <div class="response" id="mce-success-response" style="display:none"></div>
                        </div>
                    </fieldset>
                </form>

                <p class="disclaimer">
                    I won't give your address to anyone else, won't send you any spam, and you can unsubscribe at any time.
                </p>
            </div>
        </div>

        <div id="carrington-about" class="widget">
            <div class="about">
                <h2 class="title">About</h2>

                <p>Hello! I'm Martin Kleppmann, entrepreneur and software craftsman.
                I co-founded <a href="http://rapportive.com/">Rapportive</a>
                (<a href="http://blog.rapportive.com/rapportive-acquired-by-linkedin">acquired</a>
                by <a href="http://www.linkedin.com/">LinkedIn</a> in 2012) and Go Test It (acquired by 
                <a href="http://www.red-gate.com/">Red Gate Software</a> in 2009).</p>

                <p>I care about making stuff that people want, great people and culture, the web and
                its future, marvellous user experiences, maintainable code and scalable architectures.</p>

                <p>I'd love to hear from you, so please leave comments, or feel free to
                <a rel="author" href="/contact.html">contact me directly</a>.</p>
            </div>
        </div>


        <div id="primary-sidebar">
        </div>

        <div id="secondary-sidebar">
            <div id="carrington-archives" class="widget">
                <h2 class="title">Recent posts</h2>
                <ul>
                    
                      <li>12 Aug 2013: <a href="/2013/08/12/system-operations-over-seven-centuries.html">System operations over seven centuries</a></li>
                    
                      <li>24 May 2013: <a href="/2013/05/24/improving-security-of-ssh-private-keys.html">Improving the security of your SSH private key files</a></li>
                    
                      <li>05 Dec 2012: <a href="/2012/12/05/schema-evolution-in-avro-protocol-buffers-thrift.html">Schema evolution in Avro, Protocol Buffers and Thrift</a></li>
                    
                      <li>08 Oct 2012: <a href="/2012/10/08/complexity-of-user-experience.html">The complexity of user experience</a></li>
                    
                      <li>01 Oct 2012: <a href="/2012/10/01/rethinking-caching-in-web-apps.html">Rethinking caching in web apps</a></li>
                    
                    <li><a href="/archive.html">Full archive</a></li>
                </ul>
            </div>
        </div>
    </div>
</div> <!-- div.wrapper, started in 'before.html' -->

<hr class="divider" />

<div id="footer">
    <div class="wrapper">
        <p id="generator-link">
            <a rel="license" href="http://creativecommons.org/licenses/by/3.0/"
                style="float: left; padding: 0.3em 1em 0 0;"><img alt="Creative Commons License"
                src="http://i.creativecommons.org/l/by/3.0/88x31.png" /></a>
            Unless otherwise specified, all content on this site is licensed under a
            <a rel="license" href="http://creativecommons.org/licenses/by/3.0/">Creative Commons
                Attribution 3.0 Unported License</a>.
            Theme borrowed from
            <span id="theme-link"><a href="http://carringtontheme.com" title="Carrington theme for WordPress">Carrington</a></span>,
            ported to <a href="https://github.com/mojombo/jekyll">Jekyll</a> by Martin Kleppmann.
        </p>
    </div>
</div>

    </div>

    <script type="text/javascript">
        var disqus_shortname = 'martinkl';

        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = 'http://disqus.com/forums/' + disqus_shortname + '/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>

    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-7958895-1");
        pageTracker._trackPageview();
    } catch (err) {}
</script>

</body>
</html>
