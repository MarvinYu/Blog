<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head profile="http://gmpg.org/xfn/11">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Implementing constrained rigid body simulation - source code now available &mdash; Martin Kleppmann&lsquo;s blog</title>
    <link rel="stylesheet" type="text/css" media="screen, print, handheld" href="/css/typography.css" />
<link rel="stylesheet" type="text/css" media="screen" href="/css/style.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/pygments-default.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/customizations.css?2" />
<!--[if lt IE 8]>
    <link rel="stylesheet" href="/css/ie.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/martinkl?format=xml" title="Martin Kleppmann's blog" />

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" type="text/javascript"></script>
<script src="http://downloads.mailchimp.com/js/jquery.form-n-validate.js" type="text/javascript"></script>
<script src="/form.js" type="text/javascript"></script>

</head>

<body class="wordpress">
    <div id="page">
        <p id="top">
    <a id="to-content" href="#content" title="Skip to content">Skip to content</a>
</p>

<div id="header">
    <div class="wrapper">
        <strong id="blog-title">
            <a href="/" title="Home" rel="home">Martin Kleppmann</a>
        </strong>
        <p id="blog-description">Entrepreneurship, web technology and the user experience</p>
    </div>
</div>

<div id="sub-header">
    <div class="wrapper">
        <div id="navigation">
            <ul>
                <li class="page_item"><a href="/contact.html" title="About/Contact">About/Contact</a></li>
            </ul>
        </div>
    </div>
</div>

<hr class="divider">

<div class="wrapper">

        <div id="content">
            <h1>
                <div style="float: right; padding: 0 0 10px 20px;">
                    <script type="text/javascript">
                    tweetmeme_source = 'martinkl';
                    </script>
                    <script type="text/javascript" src="http://tweetmeme.com/i/scripts/button.js"></script>
                </div>

                Implementing constrained rigid body simulation - source code now available
            </h1>

            <p>My final-year project at university was on &#8221;<a href='http://maniation.com/'>Rigid body simulation for 3D character animation</a>&#8221;, which is a very fancy way of saying that I spent a year trying to make a video of a person falling down a flight of stairs. Without hurting any real people obviously &#8211; it&#8217;s all simulated and 3D animated, and most of the content of the project is working out the maths and the algorithms to calculate how bodies move and rotate in space, how they collide, and how they react when they are being held together by joints. I started out on that project thinking it would be fun, and it actually turned out to be fairly hard, so I <a href='http://www.cl.cam.ac.uk/techreports/UCAM-CL-TR-683.html'>published the results in a technical report</a> of the University of Cambridge afterwards.</p>

<p>More importantly, <a href='http://www.youtube.com/watch?v=WJLJlTx0M0E'>here&#8217;s the video</a> which was the end result of the project. It presents several scenes of increasing complexity:</p>

<ul>
<li>starting with simple pendulums (2 pendulums joined together, as well as 3-part, 8-part and 25-part pendulums &#8211; demonstrating basic rigid body movement and simple joint constraints),</li>

<li>continuing with <a href='http://en.wikipedia.org/wiki/Newton&apos;s_cradle'>Newton&#8217;s Cradle</a> (aka Newton&#8217;s Balls) with both fully elastic and less ideal collisions,</li>

<li>followed by a scene of 10 cubes falling, bouncing off a table and off each other (demonstrating more complex collisions and resting contact between bodies),</li>

<li>and ending with two scenes in which a human figure (Alfred) falls down a straight staircase and a spiral staircase (lots of complex joints, collisions and interactions going on).</li>
</ul>
<object classid='clsid:d27cdb6e-ae6d-11cf-96b8-444553540000' codebase='http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0' height='350' width='425'><param name='src' value='http://www.youtube.com/v/WJLJlTx0M0E' /><embed height='350' src='http://www.youtube.com/v/WJLJlTx0M0E' type='application/x-shockwave-flash' width='425' /></object>
<p>There&#8217;s a better quality MPEG download on <a href='http://www.maniation.com'>maniation.com</a>. Feel free to <a href='http://www.cl.cam.ac.uk/techreports/UCAM-CL-TR-683.html'>download and read the report</a>; it&#8217;s not the most exciting read and contains a lot of maths, but it does contain one or two minor new discoveries. I tried to make it unpretentious and useful by explaining the material in such a way that it serves as a readable and useful introduction to the topic (mainly because I struggled to find decent introductory texts myself).</p>

<p>And in fact, in the 2 years since I completed the project I have had a few people contact me and ask for further details and/or bits of source code for their own projects. I have not developed it any further and probably won&#8217;t be doing so anytime soon, but I&#8217;m still keen to hear from anybody who&#8217;s doing things in this space.Â And as a help for anybody working on their own physics engine, I am now releasing some of the source code from my project.</p>

<p><strong>SOURCE CODE NOW AVAILABLE</strong></p>

<p>The code is in Java 5 and covers some of the fundamental data structures and algorithms which I needed to implement:</p>

<ul>
<li>A bunch of mathematical datatypes: vectors, matrices, sparse matrices, quaternions etc.</li>

<li>Some numerical algorithms: a Runge-Kutta ODE solver and a conjugate gradient solver for systems of linear equations. These are taken from <a href='http://www.nr.com/'>Numerical Recipes</a>.</li>

<li>Implementations of a number of different constraint and collision types, as described in the report. This includes code for the Jacobians, those crazy matrices which get unbelievably complicated for some of the more tricky types of constraint.</li>

<li>An implementation of the simulation loop using constraints and collisions, variable step sizes, and backtracking to find the time of a collision.</li>
</ul>

<p>Note that this is not elegant, optimised or even particularly robust code; if you&#8217;re writing a computer game and need a physics engine, consider using something like the <a href='http://www.ode.org/'>Open Dynamics Engine</a> (open source), <a href='http://www.tokamakphysics.com/'>Tokamak</a> (open source) or <a href='http://www.havok.com/'>Havok</a> (commercial). But if you want to learn how to make a simulation like this using <a href='http://en.wikipedia.org/wiki/Lagrange_multiplier'>Lagrange multiplier</a> methods, then maybe this is for you.</p>

<p>You will quickly notice that the source is not complete. Hell, there&#8217;s not even a &#8216;main&#8217; method. That&#8217;s deliberate &#8211; this code is there to help you figure out how this stuff works, it&#8217;s not intended to work out of the box. If you want to write an application which uses it, you&#8217;re probably going to have read the whole report and some of the papers it references, read all of the code, think about it for a while, get annoyed about the fact that I didn&#8217;t put more comments in the code (sorry), and then start writing some stuff around it.</p>

<p>Nevertheless, I hope it will be useful. I release it under a <a href='http://www.opensource.org/licenses/mit-license.php'>MIT license</a>.</p>

<p><a href='http://www.maniation.com/maniation.zip'>Download the source code</a></p>

            

            <div id="disqus_thread"></div>
        </div>
            <div id="sidebar">
        <div id="carrington-subscribe" class="widget">
            <h2 class="widget-title">Subscribe</h2>
            <a class="feed" title="RSS 2.0 feed for posts" rel="alternate" href="http://feeds.feedburner.com/martinkl">
                Site <acronym title="Really Simple Syndication">RSS</acronym> feed
            </a>

            <div id="mc_embed_signup">
                <p>
                    Enjoyed this? To get notified when I write something new,
                    <a href="http://twitter.com/martinkl">follow me</a> on Twitter,
                    <a href="http://feeds.feedburner.com/martinkl">subscribe</a> to the RSS feed,
                    or type in your email address:
                </p>

                <form action="http://rapportive.us2.list-manage.com/subscribe/post?u=9a1adaf549282981a96e171d1&amp;id=4543b695f6"
                    method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank">
                    <fieldset>
                        <div class="mc-field-group">
                            <label for="mce-EMAIL">Email:</label>
                            <input type="text" value="" name="EMAIL" class="required email" id="mce-EMAIL">
                            <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="btn">
                        </div>
                        <div id="mce-responses">
                            <div class="response" id="mce-error-response" style="display:none"></div>
                            <div class="response" id="mce-success-response" style="display:none"></div>
                        </div>
                    </fieldset>
                </form>

                <p class="disclaimer">
                    I won't give your address to anyone else, won't send you any spam, and you can unsubscribe at any time.
                </p>
            </div>
        </div>

        <div id="carrington-about" class="widget">
            <div class="about">
                <h2 class="title">About Martin Kleppmann</h2>

                <p>Hello! I'm Martin Kleppmann, entrepreneur and software craftsman in
                <a href="http://en.wikipedia.org/wiki/San_Francisco">San Francisco</a> (previously in
                <a href="http://en.wikipedia.org/wiki/Cambridge">Cambridge, UK</a>). I care about
                making stuff that people want, great people and culture, the web and its future,
                marvellous user experiences, maintainable code and scalable architecture.</p>

                <p>I am co-founder of <a href="http://rapportive.com/">Rapportive</a>, together with
                <a href="http://www.samstokes.co.uk/">Sam Stokes</a> and
                <a href="http://twitter.com/rahulvohra">Rahul Vohra</a>. We make a nifty tool which
                gives you profiles about your contacts right inside Gmail. Previously I founded Go Test It
                (<a href="http://go-test.it/blog/2009/11/30/red-gate-acquires-go-test-it.html">acquired</a> by
                <a href="http://www.red-gate.com/">Red Gate Software</a> in 2009).</p>

                <p>I'd love to hear from you, so please leave comments, or feel free to
                <a rel="author" href="/contact.html">contact me directly</a>.</p>
            </div>
        </div>


        <div id="primary-sidebar">
        </div>

        <div id="secondary-sidebar">
            <div id="carrington-archives" class="widget">
                <h2 class="title">Recent posts</h2>
                <ul>
                    
                      <li>16 Aug 2011: <a href="/2011/08/16/founderly-interview.html">My FounderLY interview</a></li>
                    
                      <li>15 Mar 2011: <a href="/2011/03/15/whats-so-special-about-y-combinator.html">What's so special about Y Combinator?</a></li>
                    
                      <li>07 Mar 2011: <a href="/2011/03/07/accounting-for-computer-scientists.html">Accounting for Computer Scientists</a></li>
                    
                      <li>21 Dec 2010: <a href="/2010/12/21/having-a-launched-product-is-hard.html">Having a launched product is hard</a></li>
                    
                      <li>30 Oct 2010: <a href="/2010/10/30/intuition-has-no-transfer-encoding.html">Intuition has no transfer encoding</a></li>
                    
                    <li><a href="/archive.html">Full archive</a></li>
                </ul>
            </div>
        </div>
    </div>
</div> <!-- div.wrapper, started in 'before.html' -->

<hr class="divider" />

<div id="footer">
    <div class="wrapper">
        <p id="generator-link">
            <a rel="license" href="http://creativecommons.org/licenses/by/3.0/"
                style="float: left; padding: 0.3em 1em 0 0;"><img alt="Creative Commons License"
                src="http://i.creativecommons.org/l/by/3.0/88x31.png" /></a>
            Unless otherwise specified, all content on this site is licensed under a
            <a rel="license" href="http://creativecommons.org/licenses/by/3.0/">Creative Commons
                Attribution 3.0 Unported License</a>.
            Theme borrowed from
            <span id="theme-link"><a href="http://carringtontheme.com" title="Carrington theme for WordPress">Carrington</a></span>,
            ported to <a href="https://github.com/mojombo/jekyll">Jekyll</a> by Martin Kleppmann.
        </p>
    </div>
</div>

    </div>

    <script type="text/javascript">
        var disqus_shortname = 'martinkl';
        var disqus_url = 'http://martin.kleppmann.com/2008/10/25/implementing-constrained-rigid-body-simulation-source-code-now-available.html';
        var disqus_identifier = disqus_url;

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>

    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-7958895-1");
        pageTracker._trackPageview();
    } catch (err) {}
</script>

</body>
</html>
