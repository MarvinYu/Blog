<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head profile="http://gmpg.org/xfn/11">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Implementing constrained rigid body simulation - source code now available &mdash; Martin Kleppmann&rsquo;s blog</title>
    <link rel="stylesheet" type="text/css" media="screen, print, handheld" href="/css/typography.css" />
<link rel="stylesheet" type="text/css" media="screen" href="/css/style.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/pygments-default.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/ansi2html.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/customizations.css?4" />
<!--[if lt IE 8]>
    <link rel="stylesheet" href="/css/ie.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/martinkl?format=xml" title="Martin Kleppmann's blog" />

</head>

<body class="wordpress">
    <div id="page">
        <p id="top">
    <a id="to-content" href="#content" title="Skip to content">Skip to content</a>
</p>

<div id="header">
    <div class="wrapper">
        <strong id="blog-title">
            <a href="/" title="Home" rel="home">Martin Kleppmann</a>
        </strong>
    </div>
</div>

<div id="sub-header">
    <div class="wrapper">
        <div id="navigation">
            <ul>
                <li class="page_item"><a href="/contact.html" title="About/Contact">About/Contact</a></li>
            </ul>
        </div>
    </div>
</div>

<hr class="divider">


        <div class="wrapper">
            <div id="content">
                <a class="twitter-share-button" href="https://twitter.com/share" data-text="Implementing constrained rigid body simulation - source code now available"
                    data-via="martinkl" data-related="martinkl" data-size="large" data-count="none">Tweet</a>

                <h1>Implementing constrained rigid body simulation - source code now available</h1>

                <p>My final-year project at university was on “<a href="http://maniation.com/">Rigid body simulation for 3D character
animation</a>”, which is a very fancy way of saying that I spent a year trying
to make a video of a person falling down a flight of stairs. Without hurting any real people
obviously – it’s all simulated and 3D animated, and most of the content of the project is working
out the maths and the algorithms to calculate how bodies move and rotate in space, how they collide,
and how they react when they are being held together by joints. I started out on that project
thinking it would be fun, and it actually turned out to be fairly hard, so I
<a href="http://www.cl.cam.ac.uk/techreports/UCAM-CL-TR-683.html">published the results in a technical
report</a> of the University of Cambridge
afterwards.</p>

<p>More importantly,
<a href="http://www.youtube.com/watch?v=WJLJlTx0M0E">here’s the video</a> which was the end result of the
project. It presents several scenes of increasing
complexity:</p>

<ul>
  <li>starting with simple pendulums (2 pendulums joined together, as well as 3-part,
8-part and 25-part pendulums – demonstrating basic rigid body movement and simple joint
constraints),</li>
  <li>continuing with
<a href="http://en.wikipedia.org/wiki/Newton's_cradle">Newton’s Cradle</a> (aka Newton’s Balls) with both fully
elastic and less ideal
collisions,</li>
  <li>followed by a scene of 10 cubes falling, bouncing off a table and off each
other (demonstrating more complex collisions and resting contact between
bodies),</li>
  <li>and ending with two scenes in which a human figure (Alfred) falls down a straight
staircase and a spiral staircase (lots of complex joints, collisions and interactions going
on).</li>
</ul>

<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" width="425" height="350" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"><param name="src" value="http://www.youtube.com/v/WJLJlTx0M0E" /><embed type="application/x-shockwave-flash" width="425" height="350" src="http://www.youtube.com/v/WJLJlTx0M0E" /></object>

<p>There’s a better quality MPEG download
on
<a href="http://www.maniation.com">maniation.com</a>. Feel free to
<a href="http://www.cl.cam.ac.uk/techreports/UCAM-CL-TR-683.html">download and read the report</a>; it’s not
the most exciting read and contains a lot of maths, but it does contain one or two minor new
discoveries. I tried to make it unpretentious and useful by explaining the material in such a way
that it serves as a readable and useful introduction to the topic (mainly because I struggled to
find decent introductory texts myself).</p>

<p>And in fact, in the 2 years since I completed the project I
have had a few people contact me and ask for further details and/or bits of source code for their
own projects. I have not developed it any further and probably won’t be doing so anytime soon, but
I’m still keen to hear from anybody who’s doing things in this space. And as a help for anybody
working on their own physics engine, I am now releasing some of the source code from my
project.</p>

<p><strong>SOURCE CODE NOW AVAILABLE</strong></p>

<p>The code is in Java 5 and covers some of the fundamental
data structures and algorithms which I needed to
implement:</p>

<ul>
  <li>A bunch of mathematical datatypes: vectors, matrices, sparse matrices, quaternions etc.</li>
  <li>Some numerical algorithms: a Runge-Kutta ODE solver and a conjugate gradient solver
for systems of linear equations. These are taken from
<a href="http://www.nr.com/">Numerical Recipes</a>.</li>
  <li>Implementations of a number of different constraint and
collision types, as described in the report. This includes code for the Jacobians, those crazy
matrices which get unbelievably complicated for some of the more tricky types of
constraint.</li>
  <li>An implementation of the simulation loop using constraints and collisions,
variable step sizes, and backtracking to find the time of a collision.</li>
</ul>

<p>Note that this is
not elegant, optimised or even particularly robust code; if you’re writing a computer game and need
a physics engine, consider using something like the
<a href="http://www.ode.org/">Open Dynamics Engine</a> (open source),
<a href="http://www.tokamakphysics.com/">Tokamak</a> (open source) or
<a href="http://www.havok.com/">Havok</a> (commercial). But if you want to learn how to make a simulation like
this using
<a href="http://en.wikipedia.org/wiki/Lagrange_multiplier">Lagrange multiplier</a> methods, then maybe this is
for you.</p>

<p>You will quickly notice that the source is not complete. Hell, there’s not even a ‘main’
method. That’s deliberate – this code is there to help you figure out how this stuff works, it’s
not intended to work out of the box. If you want to write an application which uses it, you’re
probably going to have read the whole report and some of the papers it references, read all of the
code, think about it for a while, get annoyed about the fact that I didn’t put more comments in the
code (sorry), and then start writing some stuff around it.</p>

<p>Nevertheless, I hope it will be useful. I release it under a
<a href="http://www.opensource.org/licenses/mit-license.php">MIT license</a>.</p>

<p><a href="https://github.com/ept/maniation">Download the source code</a></p>


                

                <div id="disqus_thread"></div>
            </div>

            <div id="sidebar">
                <div id="carrington-subscribe" class="widget">
    <h2 class="widget-title">Subscribe</h2>
    <a class="feed" title="RSS 2.0 feed for posts" rel="alternate" href="http://feeds.feedburner.com/martinkl">
        Site <acronym title="Really Simple Syndication">RSS</acronym> feed
    </a>

    <div id="mc_embed_signup">
        <p>
            To get notified when I write something new,
            <a href="https://twitter.com/martinkl">follow me</a> on Twitter,
            <a href="http://feeds.feedburner.com/martinkl">subscribe</a> to the RSS feed,
            or enter your email address:
        </p>

        <form action="//kleppmann.us2.list-manage.com/subscribe/post?u=9a1adaf549282981a96e171d1&amp;id=4543b695f6"
            method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" target="_blank" novalidate>
            <fieldset>
                <div class="mc-field-group">
                    <label for="mce-EMAIL">Email address:</label>
                    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
                    <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
                </div>
                <div style="position: absolute; left: -5000px;"><input type="text" name="b_9a1adaf549282981a96e171d1_4543b695f6" tabindex="-1" value=""></div>
            </fieldset>
        </form>

        <p class="disclaimer">
            I won't give your address to anyone else, won't send you any spam, and you can unsubscribe at any time.
        </p>
    </div>
</div>

<div id="primary-sidebar">
    <div id="book-promo" class="widget">
        <h2 class="title">My book</h2>
        <p><a href="http://www.anrdoezrs.net/click-7658334-11260198?url=http%3A%2F%2Fshop.oreilly.com%2Fproduct%2F0636920032175.do%3Fcmp%3Daf-strata-books-videos-product_cj_9781491903094_%2525zp&cjsku=0636920032175" target="_top"><img src="/images/book-cover-small.png" border="0" alt="Designing Data-Intensive Applications" width="180" height="236"/></a></p>
        <p>I'm writing a book for O'Reilly, called
        <a href="http://dataintensive.net">Designing Data-Intensive Applications</a>.</p>
    </div>

    <div id="tweets" class="widget">
        <a class="twitter-timeline" data-dnt="true" href="https://twitter.com/martinkl" data-widget-id="557543934298423296">Tweets by @martinkl</a>
    </div>
</div>

                


<div id="secondary-sidebar">
    <div class="widget">
        <h2 class="title">Recent posts</h2>
        <ul>
            
              <li>27 May 2015: <a href="/2015/05/27/logs-for-data-infrastructure.html">Using logs to build a solid data infrastructure (or: why dual writes are a bad idea)</a></li>
            
              <li>11 May 2015: <a href="/2015/05/11/please-stop-calling-databases-cp-or-ap.html">Please stop calling databases CP or AP</a></li>
            
              <li>23 Apr 2015: <a href="/2015/04/23/bottled-water-real-time-postgresql-kafka.html">Bottled Water: Real-time integration of PostgreSQL and Kafka</a></li>
            
              <li>13 Apr 2015: <a href="/2015/04/13/real-time-full-text-search-luwak-samza.html">Real-time full-text search with Luwak and Samza</a></li>
            
              <li>04 Mar 2015: <a href="/2015/03/04/turning-the-database-inside-out.html">Turning the database inside-out with Apache Samza</a></li>
            
            <li><a href="/archive.html">Full archive</a></li>
        </ul>
    </div>

    <div class="widget">
        <h2 class="title">Conference talks</h2>
        <ul>
            
              <li><a href="/2015/11/05/streams-as-team-interface-at-oredev.html">05 Nov 2015 at Øredev</a></li>
            
              <li><a href="/2015/11/03/streams-crdts-databases-at-code-mesh.html">03 Nov 2015 at Code Mesh</a></li>
            
              <li><a href="/2015/10/01/data-liberation-with-kafka-at-strata.html">01 Oct 2015 at Strata + Hadoop World</a></li>
            
              <li><a href="/2015/09/26/transactions-at-strange-loop.html">26 Sep 2015 at Strange Loop</a></li>
            
              <li><a href="/2015/06/02/change-capture-at-berlin-buzzwords.html">02 Jun 2015 at Berlin Buzzwords</a></li>
            
            <li><a href="/talks.html">Full archive</a></li>
        </ul>
    </div>
</div>

            </div>
        </div>

        <hr class="divider" />

<div id="footer">
    <div class="wrapper">
        <p id="generator-link">
            <a rel="license" href="http://creativecommons.org/licenses/by/3.0/"
                style="float: left; padding: 0.3em 1em 0 0;"><img alt="Creative Commons License"
                src="/images/creative-commons.png" width="88" height="31" /></a>
            Unless otherwise specified, all content on this site is licensed under a
            <a rel="license" href="http://creativecommons.org/licenses/by/3.0/">Creative Commons
                Attribution 3.0 Unported License</a>.
            Theme borrowed from
            <span id="theme-link"><a href="http://carringtontheme.com" title="Carrington theme for WordPress">Carrington</a></span>,
            ported to <a href="https://github.com/mojombo/jekyll">Jekyll</a> by Martin Kleppmann.
        </p>
    </div>
</div>

<img src="https://www.lduhtrp.net/image-7658334-11260198" width="1" height="1" border="0"/>

    </div>

    <script type="text/javascript">
    var disqus_shortname = 'martinkl';
    var disqus_url = 'http://martin.kleppmann.com/2008/10/25/implementing-constrained-rigid-body-simulation-source-code-now-available.html';
    var disqus_identifier = disqus_url;

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

    <!-- Google Analytics -->
<script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-7958895-1");
        pageTracker._trackPageview();
    } catch (err) {}
</script>

<!-- Twitter -->
<script>
!function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0],
        p = /^http:/.test(d.location) ? 'http' : 'https';
    if (!d.getElementById(id)) {
        js = d.createElement(s);
        js.id = id;
        js.src = p + "://platform.twitter.com/widgets.js";
        fjs.parentNode.insertBefore(js,fjs);
    }
}(document,"script","twitter-wjs");
</script>

</body>
</html>
